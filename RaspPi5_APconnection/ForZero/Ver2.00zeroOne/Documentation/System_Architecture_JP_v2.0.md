# 環境データ測定システムのシステムアーキテクチャ
**バージョン: 2.0.0 (BME680のみ)**

このドキュメントでは、Raspberry Pi 5（P1）をセントラルハブとし、Raspberry Pi Pico 2Wデバイス（P2-P6）をセンサーノードとして使用するスタンドアロン環境データ測定システムのアーキテクチャについて説明します。バージョン2.0はBME680センサーのみで動作するように設計されています。

## システム概要

環境データ測定システムは、複数のセンサーノードから環境データを収集、保存、可視化するように設計されています。システムは以下で構成されています：

1. **Raspberry Pi 5（P1）** - セントラルハブ
2. **Raspberry Pi Pico 2W（P2-P6）** - センサーノード
3. **BME680センサー** - 温度、湿度、大気圧、ガスパラメータの測定用

## ハードウェアアーキテクチャ

### Raspberry Pi 5（P1）

Raspberry Pi 5はシステムのセントラルハブとして機能します。その役割：
- センサーノード用のWiFiアクセスポイントとして機能
- データ収集サービスを実行
- データ可視化用のWebインターフェースをホスト
- 収集したデータを保存

### Raspberry Pi Pico 2W（P2-P6）

各Raspberry Pi Pico 2Wはセンサーノードとして機能します。その役割：
- BME680センサーに接続
- 環境データを収集
- WiFi経由でP1にデータを送信
- エラーや接続問題が発生した場合に自動再起動

### BME680センサー

各BME680センサーはRaspberry Pi Pico 2Wに接続され、以下を測定します：
- 温度
- 湿度
- 大気圧
- ガスパラメータ（VOCガス抵抗値）

### 接続性

- P1はSSID「RaspberryPi5_AP_Solo2」のWiFiアクセスポイントを作成
- P2-P6はこのアクセスポイントに接続
- データはHTTPリクエストを介してP2-P6からP1に送信

## ソフトウェアアーキテクチャ

### P1（Raspberry Pi 5）ソフトウェア

P1ソフトウェアはいくつかのコンポーネントで構成されています：

1. **アクセスポイントセットアップ**
   - 場所：`p1_software_solo405/ap_setup/`
   - Raspberry Pi 5をWiFiアクセスポイントとして構成
   - アクセスポイント機能に`hostapd`と`dnsmasq`を使用

2. **データ収集**
   - 場所：`p1_software_solo405/data_collection/`
   - センサーノードからのデータを受信
   - 受信したデータを検証して処理
   - データをCSVファイルに保存
   - 派生値（例：絶対湿度）を計算
   - データにアクセスするためのAPIを提供

3. **Webインターフェース**
   - 場所：`p1_software_solo405/web_interface/`
   - データ可視化用のWebベースダッシュボードを提供
   - すべてのセンサーノードからの現在の読み取り値を表示
   - 環境データの時系列グラフを表示
   - データをCSVファイルとしてエクスポート可能

4. **接続モニター**
   - 場所：`p1_software_solo405/connection_monitor/`
   - センサーノードとの接続品質を監視
   - 信号強度、ping時間、ノイズレベルを測定
   - Webインターフェースに接続状態を表示

5. **統合起動スクリプト**
   - 場所：`p1_software_solo405/start_p1_solo.py`
   - すべてのP1コンポーネントを正しい順序で起動
   - すべてのサービスが適切に実行されていることを確認
   - ステータス情報を提供

### P2-P6（Raspberry Pi Pico 2W）ソフトウェア

P2-P6ソフトウェアはいくつかのコンポーネントで構成されています：

1. **センサードライバー**
   - 場所：`sensor_drivers/`
   - BME680センサー用のインターフェースを提供
   - センサーの初期化と読み取りを処理

2. **データ送信**
   - 場所：`data_transmission/`
   - WiFi接続を管理
   - データをフォーマットしてP1に送信
   - 送信失敗時の再試行ロジックを実装

3. **エラー処理**
   - 場所：`error_handling/`
   - エラーをファイルに記録
   - ウォッチドッグ機能を実装
   - 重大なエラー発生時にデバイスを自動再起動

4. **メインプログラム**
   - 場所：`main.py`
   - すべてのコンポーネントを初期化
   - データ収集と送信を調整
   - エラー状態を処理

## データフロー

1. **データ収集**
   - BME680センサーが環境データ（温度、湿度、気圧、ガス抵抗値）を収集
   - Pico 2Wが定期的（通常30秒ごと）にセンサーからデータを読み取り

2. **データ送信**
   - Pico 2WがデータをJSON形式に整形
   - データはHTTP POSTリクエストを介してP1に送信
   - データ形式の例：
     ```json
     {
       "device_id": "P2",
       "timestamp": "2025-07-23 12:34:56",
       "temperature": 25.6,
       "humidity": 45.2,
       "pressure": 1013.2,
       "gas_resistance": 12345
     }
     ```

3. **データ処理**
   - P1がデータを受信して検証
   - 温度と湿度から絶対湿度を計算
   - データは以下の形式でCSVファイルに保存：
     ```
     timestamp,device_id,temperature,humidity,pressure,gas_resistance,,absolute_humidity
     ```
   - 以前のバージョンでCO2データがあった場所に空のフィールドがあることに注意

4. **データ保存**
   - データは2種類のファイルに保存：
     - 日次ファイル：`{device_id}_{YYYY-MM-DD}.csv`
     - 固定ファイル：`{device_id}_fixed.csv`
   - ファイルはデバイス固有のディレクトリに保存：
     - `/var/lib/raspap_solo/data/RawData_P2/`
     - `/var/lib/raspap_solo/data/RawData_P3/`
     - `/var/lib/raspap_solo/data/RawData_P4/`
     - `/var/lib/raspap_solo/data/RawData_P5/`
     - `/var/lib/raspap_solo/data/RawData_P6/`

5. **データ可視化**
   - WebインターフェースがCSVファイルからデータを読み取り
   - データは時系列グラフとして表示
   - 最新の読み取り値がダッシュボードに表示
   - 各センサーノードの接続状態が表示

## 以前のバージョンとの違い

バージョン2.0は以前のバージョンと以下の点で異なります：

1. **CO2センサーサポートの削除**
   - MH-Z19C CO2センサーの初期化と読み取りコードがコメントアウト
   - CO2データは収集・送信されない
   - WebインターフェースからCO2の可視化が削除
   - CSV形式の互換性を維持するため、CO2データがあった場所に空のフィールドを保持

2. **データ処理の変更**
   - データ検証でCO2値をチェックしない
   - CSV形式の互換性を維持するため、データ保存にCO2用の空フィールドを含む

3. **Webインターフェースの変更**
   - ダッシュボードからCO2グラフを削除
   - 最新データ表示からCO2読み取り値を削除
   - CO2グラフを読み込むJavaScriptコードをコメントアウト

## 設定

### P1の設定

P1の設定は`p1_software_solo405/data_collection/config.py`に保存されています：

```python
DEFAULT_CONFIG = {
    "data_dir": "/var/lib(FromThonny)/raspap_solo/data",
    "rawdata_p2_dir": "RawData_P2",
    "rawdata_p3_dir": "RawData_P3",
    "rawdata_p4_dir": "RawData_P4",
    "rawdata_p5_dir": "RawData_P5",
    "rawdata_p6_dir": "RawData_P6",
    "listen_port": 5000,
    "api_port": 5000,
    "file_rotation_interval": 86400,  # 24時間（秒単位）
    "cleanup_interval": 3600,  # 1時間（秒単位）
    "retention_days": 30,
    "log_level": "INFO",
    "debug_mode": False,
    "rest_time": 0.1,  # 操作間の休止時間（100ms）
    "log_frequency": 5,  # 5回に1回のみログを記録
    "rate_limit_window": 60,  # レート制限ウィンドウ（秒単位）
    "rate_limit_count": 10,  # ウィンドウあたりの最大リクエスト数
}
```

### P2-P6の設定

P2-P6の設定は各Pico 2Wの`main.py`に保存されています：

```python
# ===== デバイス設定 =====
DEVICE_ID = "P2"  # 適宜P3、P4、P5、P6に変更
WIFI_SSID = "RaspberryPi5_AP_Solo2"
WIFI_PASSWORD = "raspberry"
SERVER_IP = "192.168.0.2"
SERVER_PORT = 5000
TRANSMISSION_INTERVAL = 30  # データ送信間隔（秒単位）
```

## セキュリティに関する考慮事項

1. **WiFiセキュリティ**
   - WiFiアクセスポイントはWPA2で保護
   - 本番環境ではデフォルトパスワードを変更すべき

2. **データセキュリティ**
   - データはローカルWiFiネットワーク上でのみ送信
   - データ送信に暗号化は使用されていない
   - システムはスタンドアロン操作用に設計されており、インターネット接続はしない

3. **物理的セキュリティ**
   - デバイスへの物理的アクセスを制限すべき
   - 追加のセキュリティのためにSDカード暗号化を有効にすることが可能

## 制限事項

1. **センサーの制限**
   - BME680センサーの精度には限界がある
   - ガス抵抗値は相対的なもので、絶対的な値ではない
   - 温度読み取りはデバイスの熱の影響を受ける可能性がある

2. **ネットワークの制限**
   - WiFiの範囲は限られている
   - 信号強度がデータ送信の信頼性に影響
   - 最大5つのセンサーノードを推奨

3. **ストレージの制限**
   - データはSDカードに保存され、書き込みサイクルには限りがある
   - 長期データストレージは定期的にバックアップすべき

## 将来の拡張

システムの将来的な拡張可能性：

1. **追加センサーのサポート**
   - 他の環境センサーのサポートを追加
   - プラグアンドプレイセンサー検出を実装

2. **拡張データ分析**
   - トレンド分析と異常検出を追加
   - 長期保存用のデータ集約を実装

3. **リモートアクセス**
   - Webインターフェースへの安全なリモートアクセスを追加
   - クラウドサービスとのデータ同期を実装

4. **電源管理**
   - センサーノード用の省電力モードを実装
   - バッテリー駆動ノード用のバッテリーレベルモニタリングを追加
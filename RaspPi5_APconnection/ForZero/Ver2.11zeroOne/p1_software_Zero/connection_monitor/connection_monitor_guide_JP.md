# Connection Monitor モジュールガイド

## 概要
Connection Monitorモジュールは、Raspberry Pi 5（P1）とセンサーノードデバイス（P2、P3、P4、P5、P6）間のWiFi接続品質を監視するためのツールです。このモジュールは、信号強度、ノイズレベル、信号対雑音比（SNR）、ping時間などの接続メトリクスを測定し、表示します。Ver2.0では、BME680センサーのみを使用するシステムに対応しています。

## ファイル構成

### メインプログラムファイル

#### 1. P1_wifi_monitor_solo.py
**役割**: start_p1_solo.pyスクリプトとの互換性を提供するメインエントリーポイント  
**説明**: このファイルは、リファクタリングされたモジュールをインポートし、start_p1_solo.pyスクリプトから呼び出されたときに接続モニターを起動するためのインターフェイスを提供します。  
**使用シーン**: start_p1_solo.pyからシステム全体を起動する際に使用されます。単独で実行することも可能です。

```bash
sudo python3 P1_wifi_monitor_solo.py
```

#### 2. terminal_reporter.py
**役割**: コンソールモードで接続モニターを実行するためのスクリプト  
**説明**: このスクリプトは、P2、P3、P4、P5、P6デバイスの接続状態をターミナルに表示します。80秒ごとに更新され、各デバイスの信号強度、ノイズレベル、SNR、ping時間、信号品質評価を表示します。  
**使用シーン**: 接続品質を定期的にモニタリングしたい場合や、センサーノードの配置を最適化する際に使用します。

```bash
python3 terminal_reporter.py
```

オプションで、モニタリング間隔やインターフェイスを指定することもできます：

```bash
python3 terminal_reporter.py --interval 60 --interface wlan0
```

### サブプログラムファイル

#### 1. main.py
**役割**: 接続モニターを設定して実行するためのメイン関数を含むモジュール  
**説明**: このファイルは、コマンドライン引数を解析し、WiFiMonitorインスタンスを作成して起動します。コンソールモードまたはサービスモードで実行できます。  
**使用シーン**: 通常は直接使用せず、P1_wifi_monitor_solo.pyまたはterminal_reporter.pyから呼び出されます。

#### 2. monitor.py
**役割**: 接続モニタリングの中核機能を提供するWiFiMonitorクラスを含むモジュール  
**説明**: このファイルは、デバイスの接続状態を監視し、信号強度、ノイズレベル、SNR、ping時間などのメトリクスを測定するWiFiMonitorクラスを定義しています。また、APIサーバーを起動して、これらのメトリクスをWeb UIから利用できるようにします。  
**使用シーン**: 通常は直接使用せず、main.pyから呼び出されます。

#### 3. config.py
**役割**: 接続モニターの設定と構成を含むモジュール  
**説明**: このファイルは、モニタリング間隔、APIポート、ログディレクトリ、デバイス情報、インターフェイス、ping設定、履歴サイズなどのデフォルト設定を定義しています。Ver2.0では、モニタリング間隔が80秒に設定され、P2、P3、P4、P5、P6デバイスがサポートされています。  
**使用シーン**: 通常は直接使用せず、他のモジュールからインポートされます。設定を変更する場合は、このファイルを編集します。

#### 4. utils/console.py
**役割**: コンソール出力機能を提供するモジュール  
**説明**: このファイルは、接続状態をコンソールに表示するための関数を含んでいます。各デバイスのステータス、信号強度、ノイズレベル、SNR、ping時間、信号品質評価を表示します。  
**使用シーン**: 通常は直接使用せず、main.pyまたはterminal_reporter.pyから呼び出されます。

## 使用シナリオ

### 1. システム全体の起動（start_p1_solo.pyを使用）
システム全体を起動する場合は、start_p1_solo.pyスクリプトを使用します。このスクリプトは、アクセスポイントの設定、データ収集、Web UI、接続モニターなど、すべての必要なサービスを起動します。

```bash
sudo python3 /path/to/start_p1_solo.py
```

### 2. 接続モニターのみの起動（P1_wifi_monitor_solo.pyを使用）
接続モニターのみを起動する場合は、P1_wifi_monitor_solo.pyスクリプトを使用します。

```bash
sudo python3 P1_wifi_monitor_solo.py
```

### 3. ターミナルでの接続状態の表示（terminal_reporter.pyを使用）
ターミナルで接続状態を定期的に表示する場合は、terminal_reporter.pyスクリプトを使用します。

```bash
python3 terminal_reporter.py
```

モニタリング間隔を変更する場合：

```bash
python3 terminal_reporter.py --interval 60
```

インターフェイスを指定する場合：

```bash
python3 terminal_reporter.py --interface wlan1
```

### 4. 設定の変更
モニタリング間隔、APIポート、デバイス情報などの設定を変更する場合は、config.pyファイルを編集します。例えば、モニタリング間隔を60秒に変更する場合：

```python
DEFAULT_CONFIG = {
    "monitor_interval": 60,  # seconds
    # その他の設定...
}
```

## 注意事項
- P1_wifi_monitor_solo.pyとterminal_reporter.pyは、通常はroot権限（sudo）で実行する必要があります。
- terminal_reporter.pyは、コンソールモードで実行されるため、ターミナルを閉じると停止します。バックグラウンドで実行する場合は、nohupコマンドなどを使用してください。
- 接続モニターは、デフォルトでポート5002でAPIサーバーを起動します。このポートが他のアプリケーションで使用されていないことを確認してください。
- Ver2.0では、BME680センサーのみをサポートし、CO2センサー（MH-Z19C）はサポートしていません。
# P1 フォルダ構造と機能説明 (Ver1.5)

このドキュメントでは、P1（Raspberry Pi Zero 2W）のソフトウェア構造と機能について説明します。Ver1.5では、Raspberry Pi Zero 2Wの限られたリソースで効率的に動作するように最適化されており、自動起動機能と自己診断・回復メカニズムが追加されています。

## 目次

1. [概要](#概要)
2. [フォルダ構造](#フォルダ構造)
3. [主要コンポーネント](#主要コンポーネント)
   - [アクセスポイントセットアップ](#アクセスポイントセットアップ)
   - [データ収集](#データ収集)
   - [Webインターフェース](#webインターフェース)
   - [接続モニター](#接続モニター)
   - [起動スクリプト](#起動スクリプト)
4. [Ver1.5での新機能](#ver15での新機能)
   - [自動起動機能](#自動起動機能)
   - [自己診断・回復メカニズム](#自己診断回復メカニズム)
5. [Ver1.2での最適化](#ver12での最適化)
6. [起動方法](#起動方法)
7. [トラブルシューティング](#トラブルシューティング)

## 概要

P1（Raspberry Pi Zero 2W）は、環境データ測定システムの中心ハブとして機能します。主な役割は以下の通りです：

- P4、P5、P6のセンサーノードのためのWiFiアクセスポイントとして機能
- センサーノードから環境データを収集して保存
- データ可視化のためのWebインターフェースを提供
- センサーノードとの接続品質をモニタリング

Ver1.5では、Ver1.2の最適化に加えて、自動起動機能と自己診断・回復メカニズムが追加されています。これにより、Raspberry Pi Zero 2Wの電源投入時に自動的にシステムが起動し、エラーが発生した場合は自動的に回復するようになりました。

## フォルダ構造

P1のソフトウェアは以下のフォルダ構造で整理されています：

```
p1_software_solo405/
├── ap_setup/                # アクセスポイント設定
│   └── P1_ap_setup_solo.py  # アクセスポイント設定スクリプト
├── connection_monitor/      # 接続モニター
│   ├── api/                 # API関連
│   ├── measurements/        # 測定関連
│   ├── utils/               # ユーティリティ
│   ├── config.py            # 設定ファイル
│   ├── main.py              # メインエントリーポイント
│   ├── monitor.py           # モニター実装
│   └── monitor_v1.2.py      # 最適化されたモニター実装（Ver1.2）
├── data_collection/         # データ収集
│   ├── api/                 # API関連
│   ├── network/             # ネットワーク関連
│   ├── processing/          # データ処理
│   ├── storage/             # データ保存
│   ├── config.py            # 設定ファイル
│   ├── main.py              # メインエントリーポイント
│   ├── P1_data_collector_solo.py      # データコレクター実装
│   └── P1_data_collector_solo_v1.2.py # 最適化されたデータコレクター実装（Ver1.2）
├── web_interface/           # Webインターフェース
│   ├── api/                 # API関連
│   ├── data/                # データ関連
│   ├── static/              # 静的ファイル
│   ├── templates/           # HTMLテンプレート
│   │   ├── dashboard.html   # ダッシュボードテンプレート
│   │   ├── dashboard_text_only.html # テキストのみのダッシュボードテンプレート（Ver1.2）
│   │   └── index.html       # インデックスページテンプレート
│   ├── utils/               # ユーティリティ
│   ├── visualization/       # 可視化関連
│   ├── config.py            # 設定ファイル
│   ├── main.py              # メインエントリーポイント
│   ├── P1_app_simple.py     # シンプルなWebアプリ実装
│   └── P1_app_simple_v1.2.py # 最適化されたWebアプリ実装（Ver1.2）
├── start_p1_solo.py         # P1起動スクリプト
└── start_p1_solo_v1.5.py    # Ver1.5用P1起動スクリプト（自動起動・自己診断機能付き）
```

## 主要コンポーネント

### アクセスポイントセットアップ

**目的**: P4、P5、P6のセンサーノードのためのWiFiアクセスポイントを設定します。

**主要ファイル**:
- `P1_ap_setup_solo.py`: アクセスポイントを設定するスクリプト

**機能**:
- Raspberry Pi Zero 2WをWiFiアクセスポイントとして設定
- DHCPサーバーの設定
- DNSサーバーの設定
- IPフォワーディングの設定

### データ収集

**目的**: センサーノードから環境データを収集し、保存します。

**主要ファイル**:
- `P1_data_collector_solo.py`: 元のデータコレクター実装
- `P1_data_collector_solo_v1.2.py`: 最適化されたデータコレクター実装（Ver1.2）

**機能**:
- センサーノードからのデータ受信
- データの検証と処理
- CSVファイルへのデータ保存
- データへのAPIアクセスの提供

**Ver1.2での最適化**:
- データ受信チャンク間に休止時間を追加（100ms）
- ログ記録頻度を削減（5回に1回のみログを記録）
- メインサーバーループに休止時間を追加
- APIルートにレート制限を実装
- ファイル操作後に休止時間を追加

### Webインターフェース

**目的**: 収集したデータを表示するためのWebインターフェースを提供します。

**主要ファイル**:
- `P1_app_simple.py`: 元のWebアプリ実装
- `P1_app_simple_v1.2.py`: 最適化されたWebアプリ実装（Ver1.2）
- `dashboard.html`: 元のダッシュボードテンプレート
- `dashboard_text_only.html`: テキストのみのダッシュボードテンプレート（Ver1.2）

**機能**:
- 最新のセンサーデータの表示
- 接続状態の表示
- データのエクスポート機能
- 履歴データの表示

**Ver1.2での最適化**:
- グラフ描画を削除し、テキストのみの表示に簡略化
- 自動更新間隔を10秒から30秒に増加
- データ読み込みをオンデマンドに変更（ボタンクリックで読み込み）
- 不要なJavaScriptライブラリの読み込みを削除

### 接続モニター

**目的**: センサーノードとの接続品質をモニタリングします。

**主要ファイル**:
- `monitor.py`: 元のモニター実装
- `monitor_v1.2.py`: 最適化されたモニター実装（Ver1.2）

**機能**:
- センサーノードとの信号強度の測定
- ノイズレベルの測定
- Ping時間の測定
- 接続状態の監視

**Ver1.2での最適化**:
- モニタリング間隔を5秒から30秒に増加
- ログ記録頻度を削減（5回に1回のみログを記録）
- 測定間に休止時間を追加（100ms）
- 履歴サイズを100から60に削減
- Ping回数を5から3に削減
- Pingタイムアウトを2秒から1秒に削減

### 起動スクリプト

**目的**: すべてのコンポーネントを起動し、監視します。

**主要ファイル**:
- `start_p1_solo.py`: 元の起動スクリプト
- `start_p1_solo_v1.5.py`: Ver1.5用の起動スクリプト（自動起動・自己診断機能付き）

**機能**:
- アクセスポイントのセットアップ
- データ収集サービスの起動
- Webインターフェースの起動
- 接続モニターの起動
- プロセスの監視と再起動

**Ver1.5での拡張**:
- systemdサービスの作成機能（自動起動用）
- システムリソースモニタリング
- 指数バックオフによるプロセス再起動
- 持続的なエラーに対するシステム再起動機能
- 詳細なログ記録

## Ver1.5での新機能

### 自動起動機能

Ver1.5では、Raspberry Pi Zero 2Wの電源投入時に自動的にシステムを起動する機能が追加されています。

**主要ファイル**:
- `start_p1_solo_v1.5.py`: 自動起動機能を含む起動スクリプト

**機能**:
- systemdサービスの作成（`--create-service`オプション）
- システム起動時の自動実行
- 起動ステータスのログ記録

**使用方法**:
1. systemdサービスを作成します：
   ```bash
   sudo python3 p1_software_Zero/start_p1_solo_v1.5.py --create-service
   ```
2. サービスが正常に作成されたことを確認します：
   ```bash
   sudo systemctl status p1-environmental-monitor.service
   ```
3. システムを再起動して、自動起動をテストします：
   ```bash
   sudo reboot
   ```

### 自己診断・回復メカニズム

Ver1.5では、システムの自己診断と自動回復のためのメカニズムが追加されています。

**主要ファイル**:
- `start_p1_solo_v1.5.py`: 自己診断・回復メカニズムを含む起動スクリプト

**機能**:
- システムリソースモニタリング（メモリ使用率、CPU使用率）
- プロセスの自動再起動（データ収集、Webインターフェース、接続モニター）
- 指数バックオフによる再起動（再起動間隔を徐々に増加）
- 持続的なエラーに対するシステム再起動
- 詳細なログ記録

**設定パラメータ**:
- `max_restart_attempts`: 再起動を試みる最大回数（デフォルト: 5）
- `restart_backoff_factor`: 再起動間隔の増加係数（デフォルト: 1.5）
- `initial_restart_delay`: 初回再起動までの遅延（秒、デフォルト: 5）
- `memory_threshold`: メモリ使用率の警告しきい値（%、デフォルト: 80）
- `cpu_threshold`: CPU使用率の警告しきい値（%、デフォルト: 80）
- `system_check_interval`: システムリソースチェック間隔（秒、デフォルト: 60）
- `process_monitor_interval`: プロセスモニタリング間隔（秒、デフォルト: 30）

**注意**: システムリソースモニタリングには`psutil`モジュールが必要です。インストールされていない場合、この機能は無効になりますが、プロセスモニタリングと自動再起動は引き続き機能します。

## Ver1.2での最適化

Ver1.2では、Raspberry Pi Zero 2Wの限られたリソースで効率的に動作するように以下の最適化が行われています：

1. **処理間の休止時間の追加**:
   - データ受信チャンク間に休止時間を追加（100ms）
   - メインループに休止時間を追加
   - 測定間に休止時間を追加
   - ファイル操作後に休止時間を追加

2. **データ受信頻度の削減**:
   - モニタリング間隔を5秒から30秒に増加
   - Webインターフェースの自動更新間隔を10秒から30秒に増加

3. **ターミナル更新頻度の削減**:
   - ログ記録頻度を削減（5回に1回のみログを記録）

4. **Webインターフェースの簡略化**:
   - グラフ描画を削除し、テキストのみの表示に簡略化
   - 不要なJavaScriptライブラリの読み込みを削除
   - データ読み込みをオンデマンドに変更

5. **その他の最適化**:
   - 履歴サイズの削減
   - Ping回数の削減
   - Pingタイムアウトの削減
   - APIルートにレート制限を実装

## 起動方法

### 手動起動

P1を手動で起動するには、以下のコマンドを実行します：

```bash
cd /path/to/RaspPi5_APconnection/ForZero/Ver1.00zero
source ~/envmonitor-venv/bin/activate
sudo python3 p1_software_Zero/start_p1_solo_v1.5.py
```

### 自動起動

P1を自動起動するには、以下の手順で設定します：

1. systemdサービスを作成します：
   ```bash
   cd /path/to/RaspPi5_APconnection/ForZero/Ver1.00zero
   source ~/envmonitor-venv/bin/activate
   sudo python3 p1_software_Zero/start_p1_solo_v1.5.py --create-service
   ```

2. システムを再起動します：
   ```bash
   sudo reboot
   ```

3. サービスのステータスを確認します：
   ```bash
   sudo systemctl status p1-environmental-monitor.service
   ```

## トラブルシューティング

### 一般的な問題

1. **P1が起動しない**:
   - ログファイルを確認: `/var/log/p1_startup_solo_v1.5.log`
   - 必要なパッケージがインストールされているか確認: `pip3 list`
   - 権限を確認: `sudo`で実行してみる

2. **センサーノードからデータが受信されない**:
   - センサーノードがオンラインか確認: `ping 192.168.0.50`（P4の場合）
   - アクセスポイントが正しく設定されているか確認: `sudo systemctl status hostapd`
   - ファイアウォール設定を確認: `sudo iptables -L`

3. **Webインターフェースにアクセスできない**:
   - Webサーバーが実行されているか確認: `ps aux | grep flask`
   - ポートが開いているか確認: `sudo netstat -tulpn | grep 80`
   - ブラウザのキャッシュをクリア

4. **接続モニターが動作しない**:
   - 必要なパッケージがインストールされているか確認: `pip3 list`
   - ログファイルを確認: `/var/log/wifi_monitor_solo.log`
   - 権限を確認: `sudo`で実行してみる

5. **自動起動が機能しない**:
   - systemdサービスのステータスを確認: `sudo systemctl status p1-environmental-monitor.service`
   - ログファイルを確認: `/var/log/p1_startup_solo_v1.5.log`
   - サービスを手動で再起動: `sudo systemctl restart p1-environmental-monitor.service`

6. **システムリソースモニタリングが機能しない**:
   - psutilがインストールされているか確認: `pip3 list | grep psutil`
   - psutilをインストール: `pip3 install psutil`

### ログファイル

問題が発生した場合は、以下のログファイルを確認してください：

- 起動スクリプト: `/var/log/p1_startup_solo_v1.5.log`
- データ収集: `/var/log/data_collector_solo.log`
- 接続モニター: `/var/log/wifi_monitor_solo.log`
- Webインターフェース: `/var/log/web_interface_solo.log`

### 自己診断・回復メカニズムの確認

自己診断・回復メカニズムが正常に動作しているか確認するには：

1. プロセスモニタリングログを確認します：
   ```bash
   tail -n 100 /var/log/p1_startup_solo_v1.5.log
   ```

2. システムリソース使用状況を確認します（psutilがインストールされている場合）：
   ```bash
   grep "System resources" /var/log/p1_startup_solo_v1.5.log
   ```

3. プロセスの自動再起動履歴を確認します：
   ```bash
   grep "Restarting" /var/log/p1_startup_solo_v1.5.log
   ```

4. システム再起動履歴を確認します：
   ```bash
   grep "Rebooting system" /var/log/p1_startup_solo_v1.5.log
   ```

### サポート

問題が解決しない場合は、以下の情報を含めて開発者に連絡してください：

1. 発生している問題の詳細な説明
2. 関連するログファイルの内容
3. 使用しているRaspberry Piのモデルとバージョン
4. 実行しているコマンドと出力
# P2 フォルダ構造と機能説明 (Ver1.2)

このドキュメントでは、P2（Raspberry Pi Pico 2W）のソフトウェア構造と機能について説明します。P2はセンサーノードとして機能し、環境データを収集してP1に送信します。

## 目次

1. [概要](#概要)
2. [フォルダ構造](#フォルダ構造)
3. [主要コンポーネント](#主要コンポーネント)
   - [メインスクリプト](#メインスクリプト)
   - [データ送信](#データ送信)
   - [エラー処理](#エラー処理)
   - [センサードライバ](#センサードライバ)
4. [動作フロー](#動作フロー)
5. [トラブルシューティング](#トラブルシューティング)

## 概要

P2（Raspberry Pi Pico 2W）は、環境データ測定システムのセンサーノードとして機能します。主な役割は以下の通りです：

- BME680センサーを使用して温度、湿度、気圧、ガス抵抗を測定
- MH-Z19Cセンサーを使用してCO2濃度を測定
- 測定したデータをWiFi経由でP1に送信
- エラーが発生した場合の自動再起動

P2はP3と非常に似た構造を持っており、同じコードベースを使用しています。主な違いは設定値とデバイスIDのみです。

## フォルダ構造

P2のソフトウェアは以下のフォルダ構造で整理されています：

```
P2_software_debug/
├── data_transmission/           # データ送信関連
│   ├── P2_wifi_client_debug.py  # P2用WiFiクライアント
│   └── P3_wifi_client_debug.py  # P3用WiFiクライアント
├── error_handling/              # エラー処理関連
│   ├── P2_watchdog_debug.py     # P2用ウォッチドッグ
│   └── P3_watchdog_debug.py     # P3用ウォッチドッグ
├── sensor_drivers/              # センサードライバ
│   ├── bme680.py                # BME680センサードライバ
│   └── mhz19c.py                # MH-Z19Cセンサードライバ
└── main.py                      # メインスクリプト
```

## 主要コンポーネント

### メインスクリプト

**ファイル**: `main.py`

**目的**: システムの初期化、WiFi接続、メインループの実行を行います。

**主要機能**:
- システムの初期化（I2C、UART、LED、センサー、WiFiクライアント、ウォッチドッグ）
- WiFiネットワークへの接続
- センサーからのデータ読み取り
- データのP1への送信
- エラー処理と自動再起動

**主要関数**:
- `initialize()`: システムを初期化します
- `connect_wifi()`: WiFiネットワークに接続します
- `main_loop()`: メインループを実行します
- `safe_reset()`: 安全にシステムをリセットします
- `debug_print()`: デバッグメッセージを出力します
- `blink_led()`: LEDを点滅させます

### データ送信

**フォルダ**: `data_transmission/`

**主要ファイル**:
- `P2_wifi_client_debug.py`: P2用WiFiクライアント

**目的**: P2からP1へのデータ送信を処理します。

**主要機能**:
- WiFiネットワークへの接続
- P1サーバーへのデータ送信
- 接続状態の監視
- 再接続処理

**主要クラス**:
- `WiFiClient`: WiFi接続とデータ送信を処理するクラス

**主要メソッド**:
- `connect()`: WiFiネットワークに接続します
- `send_data()`: データをP1に送信します
- `disconnect()`: WiFiネットワークから切断します
- `is_connected()`: 接続状態を確認します

### エラー処理

**フォルダ**: `error_handling/`

**主要ファイル**:
- `P2_watchdog_debug.py`: P2用ウォッチドッグ

**目的**: システムの監視と自動再起動を行います。

**主要機能**:
- ウォッチドッグタイマーの設定
- エラーログの記録
- システムの自動再起動
- エラー状態のLED表示

**主要クラス**:
- `Watchdog`: ウォッチドッグ機能を提供するクラス

**主要メソッド**:
- `feed()`: ウォッチドッグタイマーをリセットします
- `handle_error()`: エラーを処理します
- `reset_device()`: デバイスをリセットします
- `log_error()`: エラーをログに記録します

### センサードライバ

**フォルダ**: `sensor_drivers/`

**主要ファイル**:
- `bme680.py`: BME680センサードライバ
- `mhz19c.py`: MH-Z19Cセンサードライバ

**目的**: センサーとの通信とデータ読み取りを行います。

**BME680センサー**:
- 温度、湿度、気圧、ガス抵抗の測定
- I2C通信
- センサーの初期化と設定
- データの読み取りと変換

**MH-Z19Cセンサー**:
- CO2濃度の測定
- UART通信
- センサーの初期化と設定
- データの読み取りと変換

## 動作フロー

P2の動作フローは以下の通りです：

1. **初期化**:
   - I2C、UART、LEDの初期化
   - BME680センサーの初期化
   - MH-Z19Cセンサーの初期化
   - WiFiクライアントの初期化
   - ウォッチドッグの初期化

2. **WiFi接続**:
   - P1が提供するWiFiアクセスポイントに接続
   - 接続失敗時は再試行または再起動

3. **メインループ**:
   - BME680センサーからデータ読み取り（温度、湿度、気圧、ガス抵抗）
   - MH-Z19Cセンサーからデータ読み取り（CO2濃度）
   - データをP1に送信
   - ウォッチドッグタイマーのリセット
   - 一定時間待機（30秒）
   - ループ再開

4. **エラー処理**:
   - センサー読み取りエラー時: エラーログ記録、再試行または再起動
   - WiFi接続エラー時: 再接続試行、失敗時は再起動
   - データ送信エラー時: 再送信試行、失敗時は再接続または再起動
   - ウォッチドッグタイムアウト時: 自動再起動

## トラブルシューティング

### 一般的な問題

1. **P2が起動しない**:
   - 電源を確認
   - USBケーブルを確認
   - 別のUSBポートを試す
   - ファームウェアを再書き込み

2. **センサーデータが取得できない**:
   - センサーの接続を確認
   - I2CまたはUARTの配線を確認
   - センサーの電源を確認
   - センサードライバの設定を確認

3. **WiFi接続ができない**:
   - P1が起動しているか確認
   - P1のアクセスポイントが有効か確認
   - WiFi設定（SSID、パスワード）を確認
   - P2をP1の近くに移動

4. **データがP1に送信されない**:
   - WiFi接続を確認
   - P1のデータ収集サービスが実行されているか確認
   - P1のIPアドレスとポート設定を確認
   - ファイアウォール設定を確認

### エラーコード

LEDの点滅パターンでエラーを識別できます：

- **1回点滅**: 初期化中
- **2回点滅**: WiFi接続中
- **3回点滅**: センサーエラー
- **4回点滅**: WiFi接続エラー
- **5回点滅**: データ送信エラー
- **連続点滅**: 重大なエラー、再起動中

### ログファイル

エラーログは内部フラッシュメモリに保存されます。USBケーブルでPCに接続し、Thonny IDEなどを使用して確認できます。

### サポート

問題が解決しない場合は、以下の情報を含めて開発者に連絡してください：

1. エラーログの内容
2. LEDの点滅パターン
3. 使用しているRaspberry Pi Picoのモデルとバージョン
4. センサーの型番と接続方法
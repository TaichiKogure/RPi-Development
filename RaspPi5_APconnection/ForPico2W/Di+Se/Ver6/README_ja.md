# BME680環境データモニター（自動起動・復旧機能付き）

## 概要

このプロジェクトは、Raspberry Pi Pico、BME680センサー、SSD1306 OLEDディスプレイを使用した環境データ監視システムを実装しています。システムは温度、湿度、気圧、ガス抵抗を測定し、計算された絶対湿度とともにOLEDスクリーンに表示します。

このシステムは、電源投入時の自動起動と堅牢なエラー回復メカニズムを備えた、スタンドアロンで耐障害性のあるシステムとして設計されています。

## 特徴

- **電源投入時の自動起動**: Picoの電源が入ると自動的にシステムが起動します
- **ウォッチドッグタイマー**: システムがハングしたり応答しなくなった場合に自動的にリセットします
- **エラーログ**: エラーと再起動をログファイルに記録してトラブルシューティングを支援します
- **堅牢なエラー処理**: センサーエラーやその他の障害を適切に処理します
- **視覚的フィードバック**: オンボードLEDを使用してシステムステータスとエラーを表示します
- **データ可視化**: 環境データをOLEDスクリーンに簡単なアニメーションとともに表示します

## ハードウェア要件

- Raspberry Pi PicoまたはPico W
- BME680環境センサー
- SSD1306 OLEDディスプレイ（128x64ピクセル、SPIインターフェース）
- ジャンパーワイヤー

## ハードウェア接続

### BME680センサー（I2C接続）
- VCC → 3.3V（ピン36）
- GND → GND（ピン38）
- SCL → GP1（ピン2）
- SDA → GP0（ピン1）

### SSD1306 OLEDディスプレイ（SPI接続）
- VCC → 3.3V（ピン36）
- GND → GND（ピン38）
- DIN（MOSI）→ GP3（ピン5）
- CLK（SCK）→ GP2（ピン4）
- CS → GP6（ピン9）
- DC → GP4（ピン6）
- RST → GP5（ピン7）

## ソフトウェアセットアップ

1. 以下のファイルをRaspberry Pi Picoにコピーします：
   - `boot.py` - 起動時に自動的に実行され、メインプログラムを起動します
   - `bme680_oled_monitor_updated.py` - メインプログラム
   - `bme680.py` - BME680センサードライバー
   - `ssd1306.py` - SSD1306 OLEDディスプレイドライバー

2. Picoの電源を入れてシステムを起動します

## 自動起動と復旧メカニズム

### 自動起動

システムはMicroPythonの`boot.py`メカニズムを使用して、Picoの電源が入ったときに自動的にプログラムを起動します。起動シーケンスは次のとおりです：

1. Picoは電源投入時に`boot.py`を実行します
2. `boot.py`はメインプログラム（`bme680_oled_monitor_updated.py`）をインポートします
3. メインプログラムが初期化され、監視を開始します

### ウォッチドッグタイマー

ウォッチドッグタイマーが実装されており、システムがハングしたり応答しなくなった場合に自動的にリセットします：

1. ウォッチドッグは8秒のタイムアウトで初期化されます
2. メインプログラムはコード内の重要なポイントでウォッチドッグに「餌を与え」ます
3. プログラムがハングして8秒間ウォッチドッグに餌を与えられなかった場合、Picoは自動的にリセットします

### エラーログ

システムはエラーと再起動を`error_log.txt`という名前のファイルに記録します：

1. 各ログエントリにはタイムスタンプとエラーメッセージが含まれます
2. ログファイルは自動的に管理され、大きくなりすぎるのを防ぎます
3. ログはUSB経由でPicoに接続し、Thonnyなどのツールを使用してアクセスできます

### エラー回復

システムはいくつかのエラー回復メカニズムを実装しています：

1. **センサーエラー**: BME680センサーが無効な読み取り値を返した場合、システムは最後の有効な読み取り値を使用します
2. **初期化エラー**: 初期化に失敗した場合、システムは再起動を試みます
3. **実行時エラー**: 操作中にエラーが発生した場合、システムはエラーをログに記録して続行します
4. **重大なエラー**: 重大なエラーが発生した場合、システムは強制的にリセットします

### 視覚的フィードバック

オンボードLEDはシステムステータスに関する視覚的フィードバックを提供します：

1. **起動時**: システム起動時に3回の短い点滅
2. **エラー**: エラー発生時の急速な点滅（10回）
3. **再起動**: システム再起動時に5回の短い点滅
4. **測定**: センサー測定中にLEDが点灯

## トラブルシューティング

### システムが起動しない場合

システムが起動しない場合：

1. 電源接続を確認します
2. 必要なファイルがすべてPicoにあることを確認します
3. USB経由でPicoに接続してエラーログを確認します

### センサーエラー

センサーの読み取り値が正しくないか欠落している場合：

1. センサー接続を確認します
2. センサーアドレス（0x76または0x77）を確認します
3. センサー固有のエラーについてエラーログを確認します

### ディスプレイの問題

ディスプレイが動作しない場合：

1. ディスプレイ接続を確認します
2. SPIピン割り当てを確認します
3. ディスプレイ固有のエラーについてエラーログを確認します

## 高度な使用法

### ウォッチドッグタイムアウトの変更

ウォッチドッグタイムアウトは、`init_watchdog`関数呼び出しのパラメータを変更することで調整できます：

```python
# ウォッチドッグタイマーを初期化（8秒タイムアウト）
init_watchdog(8000)
```

### 自動起動の無効化

自動起動を無効にするには、単に`boot.py`ファイルの名前を変更するか削除します。

### ログへのアクセス

エラーログにアクセスするには：

1. PicoをUSB経由でコンピュータに接続します
2. ThonnyまたはほかのMicroPython IDEを開きます
3. Picoのファイルシステムから`error_log.txt`ファイルを開きます

## バージョン履歴

- **1.5** - 自動起動と復旧機能を追加
- **1.4** - 複数のバウンシングボックスによるアニメーションの改良
- **1.3** - 絶対湿度計算を追加
- **1.2** - ディスプレイフォーマットの強化
- **1.1** - アニメーションを追加
- **1.0** - 初期リリース
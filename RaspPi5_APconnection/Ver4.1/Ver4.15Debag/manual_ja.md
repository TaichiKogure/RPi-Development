# Raspberry Pi Pico 2W 環境モニタリングシステム デバッグ版 Ver4.15 マニュアル

## 概要

このデバッグ版（Ver4.15）は、Raspberry Pi Pico 2W（P3）の環境モニタリングシステムの問題を特定し解決するために設計されています。特に、WiFi接続の問題やThonny IDE使用時のUSB接続の切断ループなどの問題に対処します。

このバージョンでは以下の機能が強化されています：

- 詳細なWiFi接続ステータスのレポート
- Thonnyモードでの自動リセットの無効化
- オフラインモードでのセンサーデータ表示
- 複数のWiFi接続モード
- 詳細なエラーログとトラブルシューティングガイダンス
- 無限ループ内でのバックグラウンド処理の改善

## 主な修正点

このバージョンでは、以下の2つの主要な問題に対処しています：

1. **USB接続の切断ループ**：Thonny IDEでプログラムを実行すると、WiFi接続に失敗した際に`machine.reset()`が呼び出され、PicoがリセットされることでUSB接続が失われていました。

2. **WiFi接続の切断**：無限ループ内に休止処理がないと、MicroPythonシステムがWiFi接続の維持やUSBシリアル通信の応答を行う時間がなくなり、接続が切断されていました。

これらの問題に対して、以下の対策を実装しました：

1. **Thonnyモード**：
   - `DEBUG_THONNY_MODE`フラグを追加（デフォルトで有効）
   - 自動リセットを防止するための`safe_reset()`関数の修正
   - WiFi接続失敗時もプログラムが継続するオフラインモードの実装

2. **バックグラウンド処理の改善**：
   - すべての無限ループに`machine.idle()`呼び出しを追加
   - `machine.idle()`の後に短い`time.sleep(0.05)`を追加
   - これによりMicroPythonシステムがWiFi接続の維持やUSBシリアル通信の応答を行う時間を確保

## デバッグ設定

`main.py`の先頭部分にあるデバッグ設定を変更することで、デバッグ機能をカスタマイズできます：

```python
# ===== DEBUG CONFIGURATION =====
DEBUG_ENABLE = True                  # デバッグモードのマスタースイッチ
DEBUG_DISABLE_AUTO_RESET = True      # エラー時の自動リセットを無効化
DEBUG_DISABLE_WATCHDOG = False       # ハードウェアウォッチドッグを無効化（注意して使用）
DEBUG_WIFI_MODE = 2                  # WiFi接続モード（1-4、下記参照）
DEBUG_WIFI_TIMEOUT = 90              # WiFi接続タイムアウト（秒）
DEBUG_WIFI_MAX_RETRIES = 5           # WiFi接続の最大リトライ回数
DEBUG_DETAILED_LOGGING = True        # 詳細ログを有効化
DEBUG_STARTUP_DELAY = 15             # 起動遅延（秒）
DEBUG_SENSOR_WARMUP = 30             # センサーウォームアップ時間（秒）
DEBUG_RESET_DELAY = 30               # リセット前の遅延（秒）
DEBUG_THONNY_MODE = True             # Thonny開発モード
```

### WiFi接続モード

4つのWiFi接続モードが用意されています：

1. **モード1**: 自動リセットを無効化した通常接続
2. **モード2**: 拡張タイムアウトと詳細なステータスレポートを備えた接続（推奨）
3. **モード3**: 各試行前にネットワークリセットを行う接続
4. **モード4**: 段階的バックオフと複数回のリトライを行う接続

## Thonnyモードの使用方法

Thonnyモード（`DEBUG_THONNY_MODE = True`）は、Thonny IDEでの開発中に特に役立ちます。このモードでは：

1. USB接続が維持されます（自動リセットによる切断ループを防止）
2. WiFi接続中の自動リセットが無効化されます
3. 詳細なステータスレポートが表示されます
4. 拡張タイムアウトが適用されます

Thonnyモードでは、WiFi接続に失敗した場合でもプログラムは停止せず、オフラインモードで継続します。これにより、センサーデータを確認しながら接続問題をデバッグできます。

## WiFi接続のトラブルシューティング

WiFi接続に問題がある場合は、以下を確認してください：

1. **アクセスポイントの状態**: RaspberryPi5_AP_Soloが稼働しているか確認
2. **パスワード**: パスワードが正しいか確認（デフォルトは「raspberry」）
3. **接続モード**: 異なるWiFi接続モードを試す
4. **タイムアウト**: `DEBUG_WIFI_TIMEOUT`を増やす
5. **リトライ回数**: `DEBUG_WIFI_MAX_RETRIES`を増やす

接続プロセス中に表示されるステータスコードは以下の意味を持ちます：

- **0**: アイドル状態
- **1**: 接続中
- **2**: パスワードが間違っている
- **3**: アクセスポイントが見つからない
- **4**: 接続失敗
- **5**: 接続成功、IPアドレス取得中

## オフラインモード

WiFi接続に失敗した場合、システムはオフラインモードに入ります。このモードでは：

1. センサーデータが10秒ごとに読み取られ表示されます
2. データはP1サーバーに送信されません
3. プログラムは実行を継続し、手動で停止するまで動作します

オフラインモードは、WiFi接続なしでセンサーが正常に動作しているかを確認するのに役立ちます。

## エラーログ

エラーログは`/error_log_p3_debug.txt`に保存されます。このファイルには、発生したエラーの詳細情報が記録されます。

## センサー情報

このシステムは以下のセンサーを使用します：

### BME680センサー
- 温度、湿度、気圧、ガス抵抗を測定
- I2Cインターフェースを使用（アドレス: 0x77）
- ピン接続:
  - VCC -> 3.3V (Pin 36)
  - GND -> GND (Pin 38)
  - SCL -> GP1 (Pin 2)
  - SDA -> GP0 (Pin 1)

### MH-Z19C CO2センサー
- CO2濃度を測定
- UARTインターフェースを使用
- 30秒のウォームアップ時間が必要
- ピン接続:
  - VCC (赤) -> VBUS (5V, Pin 40)
  - GND (黒) -> GND (Pin 38)
  - TX (緑) -> GP9 (Pin 12)
  - RX (青) -> GP8 (Pin 11)

## 使用方法

1. Thonnyを起動し、Raspberry Pi Pico Wに接続します
2. デバッグ設定を必要に応じて調整します
3. プログラムを実行します
4. 詳細なログを確認し、問題を特定します
5. 必要に応じて設定を変更し、再試行します

## トラブルシューティング

### USB接続が繰り返し切断される場合
- `DEBUG_THONNY_MODE = True`に設定されていることを確認
- `DEBUG_DISABLE_AUTO_RESET = True`に設定されていることを確認

### センサーが検出されない場合
- I2Cアドレスが正しいか確認（BME680: 0x77）
- ピン接続を確認
- 電源を確認

### CO2センサーの読み取りが0または異常な値の場合
- ウォームアップ時間（30秒）が経過しているか確認
- ピン接続を確認
- UARTの設定を確認

### WiFi接続に失敗する場合
- アクセスポイントが稼働しているか確認
- パスワードが正しいか確認
- 異なるWiFi接続モードを試す
- タイムアウトとリトライ回数を増やす

## バックグラウンド処理の改善について

MicroPythonシステムでは、無限ループ（`while True:`）を一切休ませずに実行し続けると、WiFiの維持やUSBシリアル応答の処理を行うタイミングがなくなり、接続が切断されてしまいます。

このバージョンでは、以下の対策を実装しました：

1. **`machine.idle()`の追加**：
   - すべての無限ループに`machine.idle()`呼び出しを追加しました
   - この関数はCPUに「他の処理をする時間がある」ことを伝え、WiFiやUSB処理などのバックグラウンドタスクを実行できるようにします

2. **短いスリープの追加**：
   - `machine.idle()`の後に`time.sleep(0.05)`（50ミリ秒）の短いスリープを追加しました
   - これにより、CPUが余裕を持ってバックグラウンド処理を実行できるようになります

3. **修正された主なループ**：
   - メインループ（データ収集と送信）
   - オフラインモードのループ（センサーデータ表示）
   - エラー処理用の無限ループ

これらの変更により、Thonny IDEでの接続が安定し、WiFi接続も維持されやすくなります。

## 注意事項

1. `DEBUG_DISABLE_WATCHDOG = True`に設定すると、プログラムがハングした場合に自動的にリセットされなくなります。デバッグ中のみ使用してください。
2. Thonnyモードでは自動リセットが無効化されるため、プログラムを手動で停止する必要があります。
3. オフラインモードでは、データはP1サーバーに送信されません。
4. バックグラウンド処理のための`machine.idle()`と`time.sleep()`は、パフォーマンスに影響を与える可能性がありますが、接続の安定性のために必要です。

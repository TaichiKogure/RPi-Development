# BME680センサードライバーの更新 (Ver 4.25.1)

## 概要
このアップデートでは、P2およびP3のBME680センサードライバーを修正し、G:\RPi-Development\OK2bmeに保存されているAdafruitのアルゴリズムを忠実に使用するように変更しました。これにより、センサーからより正確な測定値を得ることができます。

## 変更内容

### 1. BME680ドライバーの更新
- Adafruitの参照実装に基づいてBME680ドライバーを完全に書き直しました
- 温度、湿度、気圧、ガス抵抗の計算アルゴリズムを参照実装と一致させました
- 高度計算機能を追加しました
- ヒーター制御を改善し、ガス測定の精度を向上させました

### 2. 主な改善点
- **温度測定**: Adafruitのアルゴリズムを使用して、より正確な温度補正を実現
- **湿度測定**: 参照実装の湿度計算アルゴリズムを採用し、精度を向上
- **気圧測定**: 参照実装の気圧計算アルゴリズムを採用し、精度を向上
- **ガス抵抗測定**: 
  - ヒーターを適切に有効化（`ctrl_gas |= 0x10`）
  - ヒーター抵抗値を適切に計算し、0〜255の範囲に制限
  - 参照実装のガス抵抗計算アルゴリズムを採用

### 3. 既存機能の維持
- I2Cアドレスの自動検出機能（0x76または0x77）
- エラー処理と診断機能
- Thonnyとの互換性向上のための安定性改善

## 技術的な詳細

### 主要な変更点
1. **ヒーター制御の改良**:
   ```python
   # ヒーターを有効化
   ctrl_gas = self._read_byte(BME680_REG_CTRL_GAS)
   ctrl_gas |= 0x10  # heater enable bit
   self._write(BME680_REG_CTRL_GAS, [ctrl_gas])
   
   # ヒーター抵抗値の計算と制限
   heatr_res = int(3.4 + ((temp - 20) * 0.6 / 100) * 1000)
   heatr_res = min(max(0, heatr_res), 255)  # 0〜255に制限
   ```

2. **周囲温度の設定**:
   ```python
   # 周囲温度のデフォルト値を設定
   amb_temp = 25  # 通常室温のデフォルト値
   ```

3. **キャリブレーションデータの読み取り方法**:
   - 参照実装のキャリブレーションデータ解析方法を採用
   - 構造体アンパックを使用してバイナリデータを適切に解析

4. **測定値の計算アルゴリズム**:
   - 温度、湿度、気圧、ガス抵抗の計算にAdafruitのアルゴリズムを使用
   - 高度計算機能を追加

## 使用方法
BME680センサーの使用方法は以前と同じですが、より正確な測定値が得られるようになりました：

```python
from machine import I2C, Pin
from sensor_drivers.bme680 import BME680_I2C

# I2Cバスの初期化
i2c = I2C(0, scl=Pin(1), sda=Pin(0), freq=100000)

# BME680センサーの初期化（アドレス自動検出）
bme = BME680_I2C(i2c)

# 測定値の取得
temperature = bme.temperature
humidity = bme.humidity
pressure = bme.pressure
gas = bme.gas
altitude = bme.altitude

# または一度にすべての測定値を取得
readings = bme.get_readings()
```

## 注意事項
- このドライバーはRaspberry Pi Pico 2W用に最適化されています
- P2およびP3の両方で同じドライバーを使用しています
- 測定値の精度はセンサーの設置環境や校正によって異なる場合があります
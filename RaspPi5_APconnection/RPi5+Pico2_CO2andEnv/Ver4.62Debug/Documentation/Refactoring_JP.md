# データ収集モジュールのリファクタリング

## 概要
このドキュメントでは、Raspberry Pi 5環境モニタリングシステムのデータ収集モジュールのリファクタリングについて説明します。このリファクタリングでは、単一の巨大なファイル（`P1_data_collector_solo.py`）から、サブディレクトリに整理された個別のコンポーネントを持つモジュラー構造に機能を移行しました。

## 変更点

### 1. モジュラー構造
元の巨大なファイル `P1_data_collector_solo.py` は、以下のモジュラー構造に置き換えられました：

- **メインエントリーポイント**: `P1_data_collector_solo_new.py` - リファクタリングされたモジュールをインポートして使用する軽量なラッパー
- **サブディレクトリ**:
  - `api/` - 収集されたデータにアクセスするためのAPIサーバーとルート
  - `network/` - センサーノードからデータを受信するためのソケットサーバー
  - `processing/` - データ検証と計算機能
  - `storage/` - CSVファイル管理とメモリ内データストレージ

### 2. コンポーネントの内訳

#### APIモジュール (`api/`)
- `server.py` - データ収集APIのためのFlaskサーバーセットアップ
- `routes.py` - 収集されたデータにアクセスするためのAPIルートハンドラー

#### ネットワークモジュール (`network/`)
- `server.py` - センサーノードからデータを受信するためのソケットサーバー

#### 処理モジュール (`processing/`)
- `calculation.py` - 派生値（例：絶対湿度）を計算するための関数
- `validation.py` - 受信したデータを検証するための関数

#### ストレージモジュール (`storage/`)
- `csv_manager.py` - CSVファイルの管理（作成、ローテーション、クリーンアップ）のための関数
- `data_store.py` - 最新のデータに素早くアクセスするためのメモリ内ストレージ

### 3. 設定
- `config.py` - 設定と便利な関数

### 4. メイン統合
- `main.py` - センサーノードからデータを収集して保存するためのすべてのコンポーネントを統合

## リファクタリングの利点

1. **保守性の向上**: 各コンポーネントは単一の責任を持ち、コードの理解と保守が容易になります。
2. **テスト性の向上**: コンポーネントを個別にテストできるため、単体テストの作成が容易になります。
3. **モジュール性の強化**: コンポーネントは独立して再利用または置き換えることができます。
4. **明確な構造**: コード構造がシステムの論理的な構成を反映するようになりました。
5. **協力の容易さ**: 複数の開発者が同時に異なるコンポーネントに取り組むことができます。

## 使用方法

新しいモジュールは元のモジュールと同じ方法で使用できます：

```bash
python3 P1_data_collector_solo_new.py [--data-dir DIR] [--listen-port PORT] [--api-port PORT]
```

## 実装の詳細

### インポート戦略
モジュールは2段階のインポート戦略を使用しています：
1. まず、パッケージ構造（`p1_software_solo405.data_collection.*`）からのインポートを試みます
2. それが失敗した場合、相対インポート（`data_collection.*`）にフォールバックします

これにより、パッケージとしてインストールされた場合と直接実行された場合の両方でモジュールが動作することが保証されます。

### エラー処理
モジュールには包括的なエラー処理が含まれています：
1. インポートエラーはキャッチされ、ログに記録されます
2. 起動エラーはキャッチされ、ログに記録されます
3. 実行時エラーはキャッチされ、ログに記録されます
4. システムはエラーまたはキーボード割り込みで正常にシャットダウンします

### ロギング
モジュールはPythonのロギングシステムを使用して、情報、警告、エラーをコンソールとログファイルの両方に記録します。

## 移行
元の `P1_data_collector_solo.py` ファイルは非推奨となり、将来のアップデートで削除される予定です。すべての機能は新しいモジュラー構造に移行されました。
# P2およびP3ソフトウェア説明 - Ver4.44

## 概要

このドキュメントでは、Raspberry Pi Pico 2W（P2およびP3）用の環境データ測定ソフトウェアについて説明します。このソフトウェアは、BME680センサーとMH-Z19Cセンサーを使用して環境データを収集し、Raspberry Pi 5（P1）に送信します。

## ディレクトリ構造

```
Ver4.44/
├── P2_software_solo44/           # P2用ソフトウェア
│   ├── data_transmission/        # データ送信モジュール
│   │   └── P2_wifi_client_solo44.py  # WiFiクライアントとデータ送信
│   ├── error_handling/           # エラー処理モジュール
│   │   └── P2_watchdog_solo44.py     # ウォッチドッグとエラーハンドリング
│   ├── sensor_drivers/           # センサードライバー
│   │   ├── bme680.py                 # BME680センサードライバー
│   │   └── mhz19c.py                 # MH-Z19Cセンサードライバー
│   └── main.py                   # メインプログラム
├── P3_software_solo44/           # P3用ソフトウェア（P2と同様の構造）
│   ├── data_transmission/        # データ送信モジュール
│   │   └── P3_wifi_client_solo44.py  # WiFiクライアントとデータ送信
│   ├── error_handling/           # エラー処理モジュール
│   │   └── P3_watchdog_solo44.py     # ウォッチドッグとエラーハンドリング
│   ├── sensor_drivers/           # センサードライバー
│   │   ├── bme680.py                 # BME680センサードライバー
│   │   └── mhz19c.py                 # MH-Z19Cセンサードライバー
│   └── main.py                   # メインプログラム
└── p1_software_solo44/           # P1用ソフトウェア
```

## P2とP3の違い

P2とP3のソフトウェアは基本的に同じ機能を持っていますが、以下の点が異なります：

1. デバイスID：P2は「P2」、P3は「P3」として識別されます
2. エラーログファイル：P2は`/error_log_p2_solo44.txt`、P3は`/error_log_p3_solo44.txt`を使用します
3. インポートパス：P2は`P2_wifi_client_solo44.py`と`P2_watchdog_solo44.py`、P3は`P3_wifi_client_solo44.py`と`P3_watchdog_solo44.py`をインポートします

これらの違いにより、P1は受信したデータがP2から来たものかP3から来たものかを区別できます。

## 主要コンポーネント

### 1. メインプログラム（main.py）

メインプログラムは以下の機能を持っています：

- センサーの初期化（BME680とMH-Z19C）
- WiFi接続の管理
- データ送信の管理
- エラー処理とウォッチドッグの管理
- 自動再起動機能

### 2. WiFiクライアント（P2_wifi_client_solo44.py / P3_wifi_client_solo44.py）

WiFiクライアントは以下の機能を持っています：

- P1のアクセスポイントへの接続
- 接続状態の監視と再接続
- データの送信とリトライ処理
- LEDによる状態表示

### 3. データ送信（DataTransmitter）

データ送信クラスは以下の機能を持っています：

- センサーからのデータ収集
- 定期的なデータ送信
- エラー時のフォールバック処理
- 最後の有効な読み取り値の保存

### 4. ウォッチドッグ（P2_watchdog_solo44.py / P3_watchdog_solo44.py）

ウォッチドッグは以下の機能を持っています：

- ハードウェアウォッチドッグによる自動リセット
- エラーのログ記録
- 安全なリセット処理
- ファイルシステムの同期

### 5. センサードライバー

#### BME680（bme680.py）

BME680センサードライバーは以下の機能を持っています：

- 温度、湿度、気圧、ガス抵抗の測定
- I2Cアドレスの自動検出（0x76または0x77）
- キャリブレーションと補正
- エラー処理と診断

#### MH-Z19C（mhz19c.py）

MH-Z19Cセンサードライバーは以下の機能を持っています：

- CO2濃度の測定
- センサーのキャリブレーション機能
- 測定範囲の設定
- 自動ベースライン補正（ABC）の設定

## インストール手順

### P2へのインストール

1. Raspberry Pi Pico 2W（P2）をThonnyなどのIDEに接続します
2. `P2_software_solo44`ディレクトリ内のすべてのファイルをPico 2Wにコピーします
3. ディレクトリ構造を維持してください（`data_transmission`、`error_handling`、`sensor_drivers`サブディレクトリを作成）
4. `main.py`をPico 2Wのルートディレクトリに配置します

### P3へのインストール

1. Raspberry Pi Pico 2W（P3）をThonnyなどのIDEに接続します
2. `P3_software_solo44`ディレクトリ内のすべてのファイルをPico 2Wにコピーします
3. ディレクトリ構造を維持してください（`data_transmission`、`error_handling`、`sensor_drivers`サブディレクトリを作成）
4. `main.py`をPico 2Wのルートディレクトリに配置します

## 動作確認

1. P1のアクセスポイントが起動していることを確認します
2. P2とP3を起動します（電源を入れるか、リセットボタンを押します）
3. P2とP3が正常に起動すると、以下のようなログが表示されます：
   ```
   === Raspberry Pi Pico 2W Environmental Monitor Ver4.44 (P2) ===
   Initializing...
   ...
   Initialization complete!
   Connecting to WiFi...
   ...
   Successfully connected to RaspberryPi5_AP_Solo
   Starting main loop...
   ```
4. P1のWebインターフェースにアクセスして、P2とP3からのデータが表示されることを確認します

## トラブルシューティング

### WiFi接続の問題

- P1のアクセスポイントが正常に動作していることを確認してください
- SSIDとパスワードが正しいことを確認してください
- P2とP3がP1の範囲内にあることを確認してください

### センサーの問題

- I2C接続（BME680）とUART接続（MH-Z19C）が正しいことを確認してください
- センサーの電源が正しく接続されていることを確認してください
- BME680のI2Cアドレスが正しいことを確認してください（自動検出が失敗した場合は手動で設定）

### データ送信の問題

- P1のデータ収集サービスが実行されていることを確認してください
- P1のIPアドレスとポートが正しいことを確認してください
- P2とP3がP1に正常に接続できることを確認してください

### エラーログの確認

エラーが発生した場合は、P2とP3のエラーログファイルを確認してください：

- P2: `/error_log_p2_solo44.txt`
- P3: `/error_log_p3_solo44.txt`

これらのファイルには、エラーの詳細と発生時刻が記録されています。

## 注意事項

- P2とP3は同時に動作させることができますが、P1のアクセスポイントに接続できる範囲内に配置する必要があります
- センサーの初期化には時間がかかる場合があります（特にMH-Z19Cは30秒のウォームアップ時間が必要）
- エラーが発生した場合、デバイスは自動的に再起動します
- ウォッチドッグタイマーは8秒に設定されているため、メインループが8秒以上応答しない場合はデバイスが自動的に再起動します
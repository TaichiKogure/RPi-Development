# Raspberry Pi 5 環境データ測定システム Ver.4.53

## 概要

このプロジェクトは、Raspberry Pi 5（P1）を中心ハブとし、2台のRaspberry Pi Pico 2W（P2、P3）をセンサーノードとして使用する、スタンドアロンの環境データ測定システムを実装しています。システムは気温、湿度、大気圧、ガスパラメータ、CO2濃度などの環境データを収集し、可視化して分析のために保存します。

## システムコンポーネント

1. **Raspberry Pi 5（P1）** - 中心ハブとして以下の機能を提供:
   - P2とP3のためのWiFiアクセスポイントとして機能
   - センサーノードからの環境データを収集・保存
   - データ可視化のためのWebインターフェースを提供
   - センサーノードとの接続品質をモニタリング

2. **Raspberry Pi Pico 2W（P2、P3）** - センサーノードとして以下の機能を提供:
   - BME680センサーを使用して環境データを収集
   - MH-Z19Bセンサーを使用してCO2レベルを測定
   - WiFi経由でデータをP1に送信
   - エラーや接続問題が発生した場合に自動再起動

3. **センサー**:
   - BME680 - 気温、湿度、大気圧、ガスパラメータを測定
   - MH-Z19B - CO2濃度を測定

## プロジェクト構造

```
RaspPi5_APconnection\Ver4.53\
├── documentation\              # ドキュメント
│   ├── インストールガイド.md     # インストール手順
│   ├── システム概要.md          # システムの概要説明
│   └── グラフ表示修正レポート.md  # グラフ表示機能の修正に関するレポート
├── p1_software_solo45\         # Raspberry Pi 5用ソフトウェア
│   ├── ap_setup\               # アクセスポイント設定
│   ├── data_collection\        # P2とP3からのデータ収集
│   ├── web_interface\          # データ可視化用WebUI
│   │   ├── P1_app_simple45.py  # メインWebアプリケーション
│   │   └── graph_viewer.py     # CSVベースのグラフ表示ツール
│   └── connection_monitor\     # WiFi信号モニタリング
├── P2_software_solo44\         # P2用ソフトウェア
│   ├── sensor_drivers\         # BME680とMH-Z19Bドライバ
│   ├── data_transmission\      # P1とのWiFi通信
│   └── error_handling\         # 自動再起動機能
└── P3_software_solo44\         # P3用ソフトウェア（P2と同様の構造）
```

## 主な機能

### P1（Raspberry Pi 5）の機能

- **デュアルWiFi機能**:
  - P2とP3用のWiFiアクセスポイント（AP）として機能
  - USB WiFiドングル経由でインターネットに接続可能
  - USB WiFiドングルがない場合はAPモードを優先
  - APとしてのIPアドレス: 192.168.0.1

- **データ管理**:
  - P2とP3からの環境データを受信・保存
  - タイムスタンプ、気温、湿度、気圧、ガスパラメータ、CO2レベルを含むCSV形式でデータを保存
  - データは `/var/lib/raspap_solo/data/RawData_P2/P2_fixed.csv` と `/var/lib/raspap_solo/data/RawData_P3/P3_fixed.csv` に保存

- **可視化**:
  - P1のWiFiに接続したスマートフォン/デバイスからアクセス可能なWebUI
  - 環境データの時系列グラフ
  - 現在の測定値のリアルタイム表示
  - データのCSVエクスポート機能
  - グラフ保存機能

- **接続モニタリング**:
  - P2とP3とのWiFi信号強度、ping時間、ノイズレベルを測定
  - 10秒ごとに更新（設定可能）
  - デバイスの物理的な配置の最適化に役立つ
  - WebUIとVNCインターフェースの両方から利用可能

### P2、P3（Raspberry Pi Pico 2W）の機能

- **センサー統合**:
  - 30秒ごとのBME680センサー読み取り
  - 30秒ごとのMH-Z19B CO2読み取り

- **データ送信**:
  - WiFi経由でP1への継続的なデータ送信
  - P2とP3デバイスの一意の識別

- **信頼性**:
  - センサーエラーやデータ収集失敗時の自動再起動
  - 再起動後の自動WiFi再接続

## 新機能: CSVベースのグラフ表示ツール

Ver.4.53では、CSVファイルを直接読み込んで表示するグラフ表示ツール（`graph_viewer.py`）が追加されました。このツールは以下の機能を提供します:

- コマンドラインからCSVファイルを指定して環境データのグラフを表示
- 表示する日数を指定
- P2とP3のデータ表示を個別に切り替え
- グラフをHTMLファイルとして保存

詳細は `documentation/グラフ表示修正レポート.md` を参照してください。

## インストールと設定

詳細なインストールガイドは `documentation/インストールガイド.md` に提供されています:

- P1（Raspberry Pi 5）をアクセスポイントとして設定する方法
- P2とP3にセンサーソフトウェアをインストール・設定する方法
- システムコンポーネントの接続方法
- システムの初期テストと検証

## 使用方法

### P1 Webインターフェースへのアクセス

1. スマートフォンまたはPCをP1のWiFiネットワーク（RaspberryPi5_AP_Solo）に接続
2. ブラウザで `http://192.168.0.1` にアクセス
3. 環境データのグラフと現在の測定値を表示

### コマンドラインからのグラフ表示

```bash
cd /path/to/p1_software_solo45/web_interface
python graph_viewer_Ver3.py --days 7  # 過去7日間のデータを表示
```

### データのエクスポート

WebUIの「データエクスポート」ボタンをクリックし、エクスポートするデバイスと期間を選択します。

## トラブルシューティング

- P2またはP3が接続されていない場合、WebUIの接続状態セクションに「オフライン」と表示されます
- センサーの読み取りエラーがある場合、ログファイル（`/var/log/web_interface_simple45.log`）を確認してください
- グラフが表示されない場合、CSVファイルが正しく生成されているか確認してください

## 開発者向け情報

- P1のソフトウェアは仮想環境内で実行されます（`envmonitor-venv`）
- 必要なPythonパッケージ: flask, pandas, plotly
- P2とP3のソフトウェアはMicroPythonで実装されています

## ライセンス

このプロジェクトはオープンソースとして提供されています。
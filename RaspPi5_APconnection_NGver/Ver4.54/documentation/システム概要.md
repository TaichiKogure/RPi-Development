# 環境データ測定システム システム概要

## システムアーキテクチャ

このシステムは、Raspberry Pi 5（P1）を中心ハブとし、2台のRaspberry Pi Pico 2W（P2、P3）をセンサーノードとして使用する分散型の環境データ測定システムです。

### 全体構成

```
[P2: Pico 2W + BME680 + MH-Z19B] ⟷ WiFi ⟷ [P1: Raspberry Pi 5] ⟷ WiFi ⟷ [P3: Pico 2W + BME680 + MH-Z19B]
                                            ↑
                                            ↓
                                    [ユーザーデバイス: スマートフォン/PC]
```

P1はWiFiアクセスポイントとして機能し、P2とP3はクライアントとしてP1に接続します。ユーザーはスマートフォンやPCをP1のWiFiネットワークに接続し、Webブラウザを通じてデータを閲覧できます。

## コンポーネント詳細

### P1（Raspberry Pi 5）

P1は以下の主要コンポーネントで構成されています：

1. **アクセスポイント設定（ap_setup）**
   - `P1_ap_setup_solo45.py`: Raspberry Pi 5をWiFiアクセスポイントとして設定
   - hostapd: WiFiアクセスポイントを提供
   - dnsmasq: DHCPサーバーとDNSサーバーを提供

2. **データ収集（data_collection）**
   - `P1_data_collector_solo45.py`: P2とP3からのデータを受信し、CSVファイルに保存
   - ソケット通信を使用してJSON形式のデータを受信
   - 受信したデータを処理し、絶対湿度を計算
   - データを日付ごとのCSVファイルと固定名のCSVファイルに保存

3. **Webインターフェース（web_interface）**
   - `P1_app_simple45.py`: Flaskベースの主要Webアプリケーション
   - リアルタイムデータ表示、グラフ表示、データエクスポート機能を提供
   - `graph_viewer.py`: CSVファイルからグラフを生成するコマンドラインツール

4. **接続モニタリング（connection_monitor）**
   - `P1_wifi_monitor_solo45.py`: P2とP3との接続品質をモニタリング
   - 信号強度、ping時間、ノイズレベルなどを測定
   - 接続状態をWebインターフェースに提供

### P2、P3（Raspberry Pi Pico 2W）

P2とP3は以下の主要コンポーネントで構成されています：

1. **センサードライバ（sensor_drivers）**
   - `bme680.py`: BME680センサーのドライバ
   - `mhz19c.py`: MH-Z19B CO2センサーのドライバ
   - センサーの初期化、キャリブレーション、データ読み取りを担当

2. **データ送信（data_transmission）**
   - `P2_wifi_client_solo44.py`/`P3_wifi_client_solo44.py`: WiFi接続とデータ送信を管理
   - P1へのソケット接続を確立
   - センサーデータをJSON形式で送信
   - 接続エラー時の再試行ロジックを実装

3. **エラー処理（error_handling）**
   - `P2_watchdog_solo44.py`/`P3_watchdog_solo44.py`: システムの安定性を監視
   - ハードウェアウォッチドッグタイマーを設定
   - エラーログを記録
   - 重大なエラー発生時に自動再起動

4. **メインプログラム**
   - `main.py`: システム全体の初期化と実行を管理
   - センサー、WiFi、ウォッチドッグの初期化
   - 定期的なデータ収集と送信のループを実行

## データフロー

1. **データ収集**
   - P2とP3のセンサーが30秒ごとに環境データを収集
   - BME680: 気温、湿度、気圧、ガス抵抗を測定
   - MH-Z19B: CO2濃度を測定

2. **データ送信**
   - 収集したデータをJSON形式に変換
   - WiFi経由でP1に送信
   - 送信データ例:
     ```json
     {
       "device_id": "P2",
       "timestamp": 1625097600,
       "temperature": 25.6,
       "humidity": 45.2,
       "pressure": 1013.25,
       "gas_resistance": 12000,
       "co2": 450
     }
     ```

3. **データ処理と保存**
   - P1がデータを受信し、絶対湿度を計算
   - データを日付ごとのCSVファイル（例: `P2_2025-07-06.csv`）に保存
   - 同時に固定名のCSVファイル（`P2_fixed.csv`）にも保存

4. **データ可視化**
   - WebUIがCSVファイルからデータを読み込み
   - Plotlyを使用してインタラクティブなグラフを生成
   - リアルタイムデータをAPIから取得して表示
   - 接続状態情報をAPIから取得して表示

## ソフトウェアアーキテクチャ

### P1のソフトウェアスタック

```
[Linux OS (Raspberry Pi OS)]
        ↑
[Python 3 + 仮想環境]
        ↑
┌───────┴───────┐
│               │
[Flask Web App]  [データ収集サービス]
│               │
└───────┬───────┘
        ↑
[ファイルシステム (CSV)]
```

### P2、P3のソフトウェアスタック

```
[MicroPython]
      ↑
┌─────┼─────┐
│     │     │
[センサー] [WiFi] [ウォッチドッグ]
│     │     │
└─────┼─────┘
      ↑
[ハードウェア (Pico 2W + センサー)]
```

## 通信プロトコル

1. **P1-P2/P3間通信**
   - プロトコル: TCP/IP（ソケット通信）
   - ポート: 5000
   - データ形式: JSON
   - 通信頻度: 30秒ごと

2. **P1-ユーザーデバイス間通信**
   - プロトコル: HTTP
   - ポート: 80
   - データ形式: HTML、JSON（API）
   - 通信: ブラウザベース

## データ保存形式

環境データは以下の形式でCSVファイルに保存されます：

```csv
timestamp,temperature,humidity,pressure,gas_resistance,co2,absolute_humidity
1625097600,25.6,45.2,1013.25,12000,450,10.5
1625097630,25.7,45.3,1013.20,12100,455,10.6
...
```

- `timestamp`: UNIXタイムスタンプ（秒）
- `temperature`: 気温（°C）
- `humidity`: 相対湿度（%）
- `pressure`: 気圧（hPa）
- `gas_resistance`: ガス抵抗（Ω）
- `co2`: CO2濃度（ppm）
- `absolute_humidity`: 絶対湿度（g/m³）- P1で計算

## セキュリティ考慮事項

1. **WiFiセキュリティ**
   - アクセスポイントはWPA2-PSKで保護
   - デフォルトパスワードは初期設定時に変更することを推奨

2. **データセキュリティ**
   - すべてのデータはローカルに保存され、外部に送信されない
   - データアクセスはローカルネットワーク内に限定

3. **物理的セキュリティ**
   - システムコンポーネントは物理的に保護された環境に設置することを推奨

## 拡張性

このシステムは以下の方法で拡張可能です：

1. **追加センサーノード**
   - さらに多くのPico 2Wノードを追加可能
   - 新しいノードごとにデバイスIDを一意に設定

2. **追加センサー**
   - 異なる種類のセンサーを追加可能
   - センサードライバを実装し、データ構造を拡張

3. **データ分析**
   - 収集したデータに対して高度な分析を実装可能
   - 機械学習モデルを統合して予測や異常検出を実装

4. **外部連携**
   - インターネット接続を追加し、クラウドサービスと連携
   - メール通知やSMS通知などのアラート機能を実装

## 制限事項

1. **スケーラビリティ**
   - 単一のRaspberry Pi 5で処理できるセンサーノード数に制限あり
   - 多数のノードを扱う場合はアーキテクチャの見直しが必要

2. **電力要件**
   - P2、P3はUSB電源が必要
   - バッテリー駆動の場合は電力消費の最適化が必要

3. **通信範囲**
   - WiFi通信の範囲に制限あり
   - 広範囲をカバーする場合はメッシュネットワークなどの検討が必要

4. **データストレージ**
   - 長期間のデータ保存には大容量ストレージが必要
   - データローテーションやアーカイブ戦略の検討が必要

## 今後の展望

1. **省電力モード**
   - バッテリー駆動時間を延ばすための省電力機能の実装

2. **メッシュネットワーク**
   - より広範囲をカバーするためのメッシュネットワーク機能の実装

3. **高度なデータ分析**
   - 傾向分析、予測モデル、異常検出の実装

4. **モバイルアプリ**
   - スマートフォン専用のモバイルアプリの開発

5. **クラウド連携**
   - クラウドサービスとの連携によるデータバックアップと遠隔アクセス
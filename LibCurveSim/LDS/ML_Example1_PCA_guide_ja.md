# 機械学習例1: 主成分分析（PCA）を用いたdQ/dV曲線の特徴抽出

## 概要
このプログラム（ML_Example1_PCA.py）は、リチウムイオン電池の充放電サイクルから得られるdQ/dV（微分容量）曲線に対して主成分分析（PCA）を適用し、特徴抽出を行います。dQ/dV曲線は電池の劣化状態を診断するための重要な指標であり、その特徴を抽出することで劣化メカニズムの理解や寿命予測に役立てることができます。

## 主成分分析（PCA）とは
主成分分析（Principal Component Analysis, PCA）は、多次元データの次元削減と特徴抽出のための統計的手法です。高次元のデータを、情報の損失を最小限に抑えながら低次元の表現に変換します。

### PCの仕組み
1. **データの標準化**: 各特徴（この場合は電圧ごとのdQ/dV値）を平均0、分散1に標準化します
2. **共分散行列の計算**: 標準化されたデータの共分散行列を計算します
3. **固有値分解**: 共分散行列の固有値と固有ベクトルを計算します
4. **主成分の選択**: 最も大きな固有値に対応する固有ベクトルを主成分として選択します
5. **データの変換**: 元のデータを主成分空間に射影します

### PCAの利点
- **次元削減**: 高次元データを少数の重要な次元に圧縮
- **ノイズ除去**: 小さな分散を持つ成分（ノイズ）を除去
- **可視化**: 高次元データを2次元や3次元で可視化可能
- **特徴抽出**: データの最も重要な特徴を抽出

## dQ/dV曲線へのPCA適用の意義

dQ/dV曲線（微分容量曲線）は、電池の充放電過程における容量の電圧に対する微分を表します。この曲線には電池内部で起こる電気化学反応に関する情報が含まれており、特にピークの位置や高さの変化は特定の劣化メカニズムと関連しています。

PCAをdQ/dV曲線に適用することで以下のことが可能になります：

1. **劣化パターンの識別**: 異なるサイクル間のdQ/dV曲線の変化パターンを少数の主成分で表現
2. **重要な電圧領域の特定**: どの電圧領域の変化が最も情報量が多いかを特定
3. **劣化の進行度合いの定量化**: 主成分空間での位置によって劣化の進行度合いを定量化
4. **異常検出**: 通常の劣化パターンから外れたサイクルを検出

## プログラムの機能

このプログラムは以下の機能を提供します：

1. **dQ/dVデータの読み込み**: 複数のサイクルのdQ/dVデータをCSVファイルから読み込み
2. **データの前処理**: 
   - 共通の電圧グリッドへの補間
   - 欠損値の処理
   - データの標準化
3. **PCA実行**: dQ/dV曲線に対してPCAを実行し、主成分を抽出
4. **結果の可視化**:
   - 主成分（ローディング）のプロット
   - 各主成分の寄与率（説明分散）のプロット
   - 主成分空間でのサイクル分布の可視化
5. **結果の保存**: 主成分と変換されたデータをCSVファイルに保存

## 使用方法

### 前提条件
- Python 3.6以上
- 必要なライブラリ: numpy, matplotlib, scipy, sklearn, pandas（オプション）

### インストール
```
pip install numpy matplotlib scipy scikit-learn
pip install pandas  # オプション
```

### 実行手順
1. まず、LibDegradationSim03_DD.pyを実行してdQ/dVデータを生成します
2. ML_Example1_PCA.pyを実行します
   ```
   python ML_Example1_PCA.py
   ```
3. プログラムは自動的に`results`ディレクトリ内のdQ/dVデータファイルを検索します
4. 見つかったデータに対してPCAを実行し、結果を表示します
5. 結果は`ml_results`ディレクトリに保存されます

## 出力の解釈

### 主成分（ローディング）
主成分のローディングプロットは、各電圧におけるdQ/dV値の重要度を示します。絶対値が大きい部分は、その電圧領域がデータの変動に大きく寄与していることを意味します。これにより、電池劣化に最も影響を与える電圧領域を特定できます。

### 説明分散
各主成分がデータの全体の分散のどれだけを説明しているかを示します。例えば、第1主成分が80%の分散を説明している場合、データの変動の大部分はこの1つの成分で表現できることを意味します。

### 主成分空間でのサイクル分布
サイクル数に応じて色分けされた主成分空間でのデータ点の分布を示します。これにより、サイクル進行に伴う劣化パターンの変化を視覚的に確認できます。点が連続的に変化している場合は徐々に劣化が進行していることを、点が集中している場合は劣化が安定していることを示唆します。

## 学術的背景

リチウムイオン電池のdQ/dV曲線に対する主成分分析の適用は、以下のような研究で報告されています：

1. Dubarry, M., Liaw, B. Y., Chen, M. S., Chyan, S. S., Han, K. C., Sie, W. T., & Wu, S. H. (2011). Identifying battery aging mechanisms in large format Li ion cells. *Journal of Power Sources*, 196(7), 3420-3425.

2. Berecibar, M., Gandiaga, I., Villarreal, I., Omar, N., Van Mierlo, J., & Van den Bossche, P. (2016). Critical review of state of health estimation methods of Li-ion batteries for real applications. *Renewable and Sustainable Energy Reviews*, 56, 572-587.

3. Weng, C., Cui, Y., Sun, J., & Peng, H. (2013). On-board state of health monitoring of lithium-ion batteries using incremental capacity analysis with support vector regression. *Journal of Power Sources*, 235, 36-44.

これらの研究では、dQ/dV曲線の特徴抽出により、電池の劣化状態の診断や寿命予測の精度向上が報告されています。

## 応用例

このプログラムで抽出された特徴（主成分）は、以下のような応用に利用できます：

1. **劣化状態の分類**: 主成分を入力とした分類モデルによる劣化状態の判別
2. **残存寿命予測**: 主成分の変化パターンに基づく寿命予測モデルの構築
3. **異常検出**: 主成分空間での外れ値検出による異常サイクルの特定
4. **劣化メカニズムの解析**: 主成分のローディングパターンに基づく劣化メカニズムの推定

## 注意事項

- PCAの結果は入力データの品質に大きく依存します。ノイズの多いデータや欠損値が多いデータでは結果が不安定になる可能性があります。
- 十分な数のサイクルデータがない場合、PCAの結果の信頼性が低下します。一般的には、特徴数（電圧ポイント数）よりも多くのサンプル（サイクル数）があることが望ましいです。
- 主成分の解釈には専門知識が必要です。特に、ローディングパターンと電気化学反応の関連付けには電池化学の知識が役立ちます。
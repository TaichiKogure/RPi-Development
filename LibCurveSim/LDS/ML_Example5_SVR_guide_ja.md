# 機械学習例5: サポートベクター回帰を用いた電池の残存有効寿命予測

## 概要
このプログラム（ML_Example5_SVR.py）は、リチウムイオン電池のdQ/dV（微分容量）曲線データを入力として、サポートベクター回帰（SVR）を用いて電池の残存有効寿命（Remaining Useful Life, RUL）を予測するモデルを構築します。これにより、電池の現在の状態から寿命終了までの残りサイクル数を予測することが可能になります。

## サポートベクター回帰（SVR）とは
サポートベクター回帰（Support Vector Regression, SVR）は、サポートベクターマシン（SVM）の回帰問題への拡張です。高次元の特徴空間において、できるだけ多くのデータポイントをある幅（ε）の範囲内に収めつつ、平坦な関数を見つけることを目的とします。

### SVRの仕組み
1. **特徴空間への写像**: 入力データを高次元の特徴空間に写像します（カーネルトリックを使用）
2. **最適化問題の解決**: ε-不感帯内にできるだけ多くのデータポイントを含み、かつマージンを最大化する超平面を見つけます
3. **予測**: 新しいデータポイントに対して、学習した関数を用いて予測値を計算します

### SVRの主なパラメータ
- **カーネル**: 線形（linear）、多項式（poly）、ガウシアン（rbf）など
- **C**: 誤差と複雑さのトレードオフを制御する正則化パラメータ
- **ε**: 不感帯の幅
- **γ**: カーネル係数（rbfカーネルなどで使用）

### SVRの利点
- **非線形関係のモデル化**: 様々なカーネル関数を用いて複雑な非線形関係をモデル化できる
- **過学習に対する頑健性**: 正則化パラメータCによって過学習を制御できる
- **外れ値に対する頑健性**: ε-不感帯とスラック変数により、外れ値の影響を抑制できる
- **理論的保証**: 最適化問題の凸性により、グローバルな最適解が保証される

## 残存有効寿命（RUL）とは
残存有効寿命（RUL）は、システムや部品が故障するまでの残り時間や使用回数を表します。電池の場合、通常は以下のように定義されます：

RUL = 寿命終了サイクル - 現在のサイクル

ここで、寿命終了サイクルは、容量維持率が特定のしきい値（例：初期容量の80%）を下回るサイクルとして定義されます。

## dQ/dV曲線からのRUL予測の意義

dQ/dV曲線は電池内部の電気化学反応に関する豊富な情報を含んでおり、劣化状態を反映します。SVRを用いたRUL予測には以下のような利点があります：

1. **早期劣化検出**: 初期のサイクルのdQ/dV曲線から将来の寿命終了時期を予測可能
2. **メンテナンス計画の最適化**: 予測された残存寿命に基づいて、電池交換やメンテナンスのタイミングを最適化
3. **劣化メカニズムの理解**: 予測に重要な特徴（電圧領域）を特定することで、劣化メカニズムの理解を深める
4. **信頼性向上**: 突然の故障リスクを低減し、システムの信頼性を向上

## プログラムの機能

このプログラムは以下の機能を提供します：

1. **データ読み込みと前処理**:
   - 複数のサイクルのdQ/dV曲線データをCSVファイルから読み込み
   - 容量維持率データをCSVファイルから読み込み
   - 残存有効寿命（RUL）の計算
   - 共通の電圧グリッドへの補間
   
2. **モデル構築と最適化**:
   - 特徴の標準化
   - オプションのPCAによる次元削減
   - グリッドサーチによるハイパーパラメータの最適化
   - 最適なSVRモデルの構築
   
3. **モデル評価**:
   - 平均絶対誤差（MAE）
   - 二乗平均平方根誤差（RMSE）
   - 決定係数（R²）
   
4. **結果の可視化**:
   - 予測値と実際の値の比較
   - 残差プロット
   - サイクル数に対するRULの推移
   - 線形カーネル使用時の特徴重要度
   
5. **結果の保存**:
   - モデルのパラメータと評価指標の保存
   - 予測結果の保存
   - RULデータの保存

## 使用方法

### 前提条件
- Python 3.6以上
- 必要なライブラリ: numpy, matplotlib, scipy, sklearn, pandas（オプション）

### インストール
```
pip install numpy matplotlib scipy scikit-learn
pip install pandas  # オプション
```

### 実行手順
1. まず、以下のプログラムを実行してデータを生成します：
   - LibDegradationSim03_DD.py: dQ/dVデータを生成
   - LibDegradationSim03_Cret_V2.py: 容量維持率データを生成
   
2. ML_Example5_SVR.pyを実行します：
   ```
   python ML_Example5_SVR.py
   ```
   
3. プログラムは自動的に以下の処理を行います：
   - `results`ディレクトリ内のdQ/dVデータファイルと容量維持率ファイルを検索
   - 複数の容量維持率ファイルが見つかった場合は、使用するファイルを選択するよう促します
   - 残存有効寿命（RUL）を計算します（デフォルトのしきい値: 容量維持率80%）
   - データを読み込み、前処理を行います
   - PCAによる次元削減を使用するかどうかを選択するよう促します
   - SVRモデルを構築し、グリッドサーチによりハイパーパラメータを最適化します
   - モデルを評価し、結果を可視化します
   - モデルと結果を`ml_results`ディレクトリに保存します

## 出力の解釈

### 予測値と実際の値の比較
このプロットでは、横軸に実際のRUL、縦軸に予測されたRULがプロットされます。点が対角線（y=x）に近いほど、予測が正確であることを示します。また、MAE、RMSE、R²の値も表示され、モデルの性能を定量的に評価できます。

### 残差プロット
残差（実際の値 - 予測値）のプロットは、モデルの予測誤差のパターンを示します。理想的には、残差はランダムに分布し、明確なパターンを示さないはずです。パターンが見られる場合は、モデルが捉えていない関係性が存在する可能性があります。

### RUL vs サイクル数
このプロットでは、横軸にサイクル数、縦軸にRULがプロットされます。青い線は実際のRUL、赤い点は予測されたRUL、黒い破線は寿命終了サイクルを示します。このプロットにより、サイクルの進行に伴うRULの減少パターンと予測の精度を視覚的に確認できます。

### 特徴重要度（線形カーネルの場合のみ）
このプロットでは、各電圧ポイントでのdQ/dV値がモデルの予測にどれだけ寄与しているかを示します。重要度が高い電圧領域は、RUL予測において特に重要な情報を含んでいると考えられます。これにより、電池劣化のメカニズムに関する洞察が得られる可能性があります。

## 学術的背景

SVRを用いた電池の残存有効寿命予測は、以下のような研究で報告されています：

1. Weng, C., Cui, Y., Sun, J., & Peng, H. (2013). On-board state of health monitoring of lithium-ion batteries using incremental capacity analysis with support vector regression. *Journal of Power Sources*, 235, 36-44.

2. Nuhic, A., Terzimehic, T., Soczka-Guth, T., Buchholz, M., & Dietmayer, K. (2013). Health diagnosis and remaining useful life prognostics of lithium-ion batteries using data-driven methods. *Journal of Power Sources*, 239, 680-688.

3. Hu, C., Jain, G., Zhang, P., Schmidt, C., Gomadam, P., & Gorka, T. (2014). Data-driven method based on particle swarm optimization and k-nearest neighbor regression for estimating capacity of lithium-ion battery. *Applied Energy*, 129, 49-55.

これらの研究では、機械学習手法を用いて電池の劣化パターンを分析し、残存有効寿命予測の精度向上が報告されています。特に、dQ/dV曲線の特徴を用いた予測手法が注目されています。

## 応用例

このプログラムで構築されたSVRモデルは、以下のような応用に利用できます：

1. **電池管理システム（BMS）**: 電気自動車やエネルギー貯蔵システムのBMSに組み込み、リアルタイムでRULを予測
2. **メンテナンス計画**: 予測されたRULに基づいて、電池交換やメンテナンスのスケジュールを最適化
3. **品質管理**: 製造直後の電池のdQ/dV曲線から、将来の寿命を予測し、品質管理に活用
4. **劣化メカニズムの研究**: 重要な特徴（電圧領域）を特定することで、劣化メカニズムの研究に貢献
5. **使用条件の最適化**: 異なる使用条件下でのRUL予測に基づき、寿命を延ばすための最適な使用条件を特定

## ハイパーパラメータの調整

SVRの性能は、ハイパーパラメータの選択に大きく依存します。本プログラムでは、グリッドサーチを用いて以下のハイパーパラメータを最適化します：

- **カーネル（kernel）**: 'linear', 'rbf', 'poly'から選択
- **正則化パラメータ（C）**: 0.1, 1, 10, 100から選択
- **不感帯の幅（epsilon）**: 0.01, 0.1, 0.2から選択
- **カーネル係数（gamma）**: 'scale', 'auto', 0.1, 0.01から選択

これらのパラメータは、データセットの特性や予測タスクの複雑さに応じて調整することで、モデルの性能を向上させることができます。

## 注意事項

- SVRモデルの学習には、十分な量のデータが必要です。サンプル数（サイクル数）が少ない場合は、予測精度が低下する可能性があります。
- RULの計算には、寿命終了の定義（容量維持率のしきい値）が重要です。アプリケーションに応じて適切なしきい値を設定する必要があります。
- 高次元データ（多数の電圧ポイント）を扱う場合、PCAによる次元削減が有効な場合があります。ただし、PCAを使用すると特徴の解釈可能性が低下する点に注意が必要です。
- 線形カーネル以外のカーネル（rbf, poly）を使用する場合、特徴重要度の直接的な解釈はできません。
- モデルの予測精度は、入力データの品質に大きく依存します。ノイズの多いデータや欠損値が多いデータでは、予測精度が低下する可能性があります。
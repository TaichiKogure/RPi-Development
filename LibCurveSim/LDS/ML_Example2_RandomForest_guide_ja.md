# 機械学習例2: ランダムフォレストを用いた電池劣化予測の特徴重要度分析

## 概要
このプログラム（ML_Example2_RandomForest.py）は、リチウムイオン電池のdQ/dV（微分容量）曲線データを用いて、容量維持率の予測に最も重要な特徴（電圧ポイント）を特定するためのランダムフォレスト回帰モデルを実装しています。これにより、電池劣化の診断や予測に最も影響力のある電圧領域を特定することができます。

## ランダムフォレストとは
ランダムフォレストは、複数の決定木（デシジョンツリー）を組み合わせたアンサンブル学習手法です。各決定木は、データの異なるサブセットとランダムに選択された特徴を使用して学習されます。予測時には、すべての決定木の予測結果を平均化（回帰問題の場合）または多数決（分類問題の場合）で最終的な予測を行います。

### ランダムフォレストの仕組み
1. **ブートストラップサンプリング**: 元のデータセットからランダムにサンプルを抽出（重複あり）
2. **特徴のランダム選択**: 各ノードで分割に使用する特徴をランダムに選択
3. **決定木の構築**: 上記のサンプルと特徴を使用して決定木を構築
4. **アンサンブル**: 複数の決定木の予測結果を統合

### ランダムフォレストの利点
- **高い予測精度**: 多数の決定木を組み合わせることで過学習を抑制し、汎化性能が向上
- **特徴重要度の評価**: 各特徴がモデルの予測にどれだけ寄与しているかを定量化
- **外れ値に対する頑健性**: 複数のモデルの平均を取るため、外れ値の影響を受けにくい
- **非線形関係の学習**: 複雑な非線形関係を学習可能

## 特徴重要度とは
ランダムフォレストでは、各特徴（この場合は各電圧ポイントでのdQ/dV値）がモデルの予測精度にどれだけ寄与しているかを「特徴重要度」として計算できます。特徴重要度は以下の方法で算出されます：

1. 各決定木において、その特徴を使用した分割によって減少した不純度（または誤差）の合計を計算
2. すべての決定木にわたってその値を平均化
3. すべての特徴の重要度の合計が1になるように正規化

特徴重要度が高い電圧ポイントは、容量維持率の予測において最も情報量が多く、電池劣化のメカニズムと強く関連している可能性があります。

## dQ/dV曲線への応用の意義

dQ/dV曲線の各電圧ポイントの重要度を分析することで、以下のような知見が得られます：

1. **重要な電圧領域の特定**: 電池劣化の予測に最も重要な電圧領域を特定
2. **電気化学反応の理解**: 特定の電圧領域の重要度が高い場合、その領域で起こる電気化学反応が劣化に大きく関与している可能性
3. **センサ設計への応用**: 重要な電圧ポイントのみを監視することで、効率的な劣化診断システムの設計が可能
4. **劣化メカニズムの分類**: 異なる劣化メカニズムでは異なる電圧領域が重要になる可能性があり、これを利用して劣化原因の分類が可能

## プログラムの機能

このプログラムは以下の機能を提供します：

1. **データ読み込み**:
   - 複数のサイクルのdQ/dVデータをCSVファイルから読み込み
   - 容量維持率データをCSVファイルから読み込み
   
2. **データ前処理**:
   - 共通の電圧グリッドへの補間
   - サイクル番号と容量維持率の対応付け
   - 特徴の標準化
   
3. **モデル学習と評価**:
   - ランダムフォレスト回帰モデルの学習
   - テストデータでのモデル評価（MAE、RMSE、R²）
   - 特徴重要度の計算
   
4. **結果の可視化**:
   - 電圧に対する特徴重要度のプロット
   - 最も重要な電圧ポイントのバープロット
   - 予測値と実際の値の比較プロット
   - 残差プロット
   
5. **結果の保存**:
   - 特徴重要度をCSVファイルに保存
   - モデル評価指標をCSVファイルに保存

## 使用方法

### 前提条件
- Python 3.6以上
- 必要なライブラリ: numpy, matplotlib, scipy, sklearn, pandas（オプション）

### インストール
```
pip install numpy matplotlib scipy scikit-learn
pip install pandas  # オプション
```

### 実行手順
1. まず、以下のプログラムを実行してデータを生成します：
   - LibDegradationSim03_DD.py: dQ/dVデータを生成
   - LibDegradationSim03_Cret_V2.py: 容量維持率データを生成
   
2. ML_Example2_RandomForest.pyを実行します：
   ```
   python ML_Example2_RandomForest.py
   ```
   
3. プログラムは自動的に以下の処理を行います：
   - `results`ディレクトリ内のdQ/dVデータファイルと容量維持率ファイルを検索
   - 複数の容量維持率ファイルが見つかった場合は、使用するファイルを選択するよう促します
   - データを読み込み、前処理を行います
   - ランダムフォレストモデルを学習し、特徴重要度を計算します
   - 結果を可視化し、CSVファイルに保存します

4. 結果は`ml_results`ディレクトリに保存されます

## 出力の解釈

### 特徴重要度プロット
電圧に対する特徴重要度のプロットは、どの電圧領域が容量維持率の予測に最も重要かを示します。重要度が高いピークは、その電圧領域での電気化学反応が劣化と強く関連していることを示唆します。

### 最重要電圧ポイント
最も重要な電圧ポイントのバープロットは、上位N個の最も影響力のある電圧ポイントを示します。これらのポイントは、劣化診断や監視システムの設計において優先的に考慮すべき領域です。

### 予測値と実際の値の比較
このプロットは、モデルの予測精度を視覚的に評価するためのものです。点が対角線（y=x）に近いほど、予測が正確であることを示します。

### 残差プロット
残差（実際の値 - 予測値）のプロットは、モデルの予測誤差のパターンを示します。理想的には、残差はランダムに分布し、明確なパターンを示さないはずです。パターンが見られる場合は、モデルが捉えていない関係性が存在する可能性があります。

## 学術的背景

リチウムイオン電池の劣化予測におけるランダムフォレストの応用は、以下のような研究で報告されています：

1. Severson, K. A., Attia, P. M., Jin, N., Perkins, N., Jiang, B., Yang, Z., ... & Braatz, R. D. (2019). Data-driven prediction of battery cycle life before capacity degradation. *Nature Energy*, 4(5), 383-391.

2. Attia, P. M., Chueh, W. C., & Harris, S. J. (2020). Revisiting the t0.5 dependence of SEI growth. *Journal of The Electrochemical Society*, 167(9), 090535.

3. Hu, X., Xu, L., Lin, X., & Pecht, M. (2020). Battery lifetime prognostics. *Joule*, 4(2), 310-346.

これらの研究では、機械学習手法を用いて電池の劣化パターンを分析し、寿命予測の精度向上が報告されています。特に、初期サイクルのデータから長期的な劣化傾向を予測する手法が注目されています。

## 応用例

このプログラムで特定された重要な特徴（電圧ポイント）は、以下のような応用に利用できます：

1. **効率的な劣化診断**: 重要な電圧ポイントのみを監視することで、計算コストを抑えつつ高精度な劣化診断が可能
2. **劣化メカニズムの分類**: 異なる劣化メカニズム（SEI形成、リチウム喪失、活物質の劣化など）では異なる電圧領域が重要になるため、重要度パターンから劣化原因を推定可能
3. **早期警告システム**: 重要な電圧領域での変化を監視することで、劣化の早期検出が可能
4. **電池設計の最適化**: 重要な電圧領域での反応を安定化させる材料や設計を選択することで、寿命を延ばす可能性

## 注意事項

- ランダムフォレストモデルの精度は、学習データの量と質に大きく依存します。十分な数のサイクルデータがない場合、結果の信頼性が低下する可能性があります。
- 特徴重要度は相対的な指標であり、絶対的な物理的意味を持つわけではありません。解釈には電気化学的知識と組み合わせることが重要です。
- 異なる劣化条件（温度、充放電レート、深度など）では、重要な電圧領域が変化する可能性があります。一般化する前に、様々な条件でのデータを分析することをお勧めします。
- モデルの過学習を防ぐため、ハイパーパラメータ（n_estimators, max_depth など）の調整が必要な場合があります。
# LibDegradationSim03_Cret.py 解説ガイド

## 概要
LibDegradationSim03_Cret.py は、リチウムイオン電池の充放電サイクルと経時劣化をシミュレーションし、サイクル数に対する容量維持率（サイクル維持率）を可視化するためのツールです。充放電曲線と共に容量維持率のグラフを表示することで、電池の劣化進行を総合的に評価できます。

## 主な機能

### 1. 容量維持率の計算と表示
- 初回放電容量を100%として、各サイクルの放電容量を相対値で表示
- サイクル数に対する容量維持率の変化をグラフ化
- 実際の放電容量の変化も同時に表示

### 2. 充放電曲線の表示
- 各サイクルの充電曲線と放電曲線を表示
- 劣化の進行による曲線形状の変化を視覚化
- UnivariateSplineを使用してデータを平滑化

### 3. 対話型パラメータ入力
- コマンドラインインターフェースを通じて、すべての重要なパラメータを対話的に設定可能
- 各パラメータにはデフォルト値が設定されており、Enterキーを押すだけで使用可能
- 入力値の検証機能により、無効な値や範囲外の値を防止

### 4. 拡張CSV出力機能
- シミュレーション結果をCSVファイルに保存するオプション
- サイクル概要（サイクル番号、容量、抵抗、放電容量、維持率）を保存
- 各サイクルの詳細な充放電データを個別のファイルに保存
- 容量維持率データを専用ファイルに保存
- タイムスタンプ付きのファイル名で上書きを防止

## 使用方法

1. プログラムを実行すると、対話モードが開始されます：
   ```
   python LibDegradationSim03_Cret.py
   ```

2. 以下のカテゴリのパラメータを順に入力します：
   - **電池の基本パラメータ**：初期容量、初期内部抵抗、最大充電電圧、最小放電電圧
   - **劣化モデルのパラメータ**：容量劣化の最大割合、劣化速度係数、抵抗増加係数、抵抗増加指数
   - **シミュレーションのパラメータ**：サイクル数、C-レート、CV充電終了の電流比率、時間ステップ、平滑化係数

3. シミュレーションが実行され、結果が4つのグラフとして表示されます：
   - 左上：充電曲線（全サイクル）
   - 右上：放電曲線（全サイクル）
   - 左下：放電容量 vs サイクル数
   - 右下：容量維持率 vs サイクル数

4. シミュレーション終了後、結果をCSVファイルに保存するかどうかを選択できます。

## パラメータ説明

| パラメータ | 説明 | デフォルト値 | 有効範囲 |
|------------|------|-------------|----------|
| 初期容量 (Ah) | 電池の初期容量 | 3.0 | > 0.1 |
| 初期内部抵抗 (Ω) | 電池の初期内部抵抗 | 0.05 | > 0.001 |
| 最大充電電圧 (V) | 充電終了電圧 | 4.1797 | 3.5 - 4.5 |
| 最小放電電圧 (V) | 放電終了電圧 | 3.0519 | 2.0 - 3.5 |
| 容量劣化の最大割合 (A) | 長期的な容量劣化の最大値（割合） | 0.1 | 0 - 1 |
| 容量劣化の速度係数 (B) | 容量劣化の進行速度 | 0.05 | > 0 |
| 抵抗増加の係数 (C) | 内部抵抗増加の大きさ | 0.05 | > 0 |
| 抵抗増加の指数 (D) | 内部抵抗増加の非線形性 | 1.0 | > 0 |
| サイクル数 | シミュレーションするサイクル数 | 20 | 1 - 1000 |
| C-レート | 充放電の電流レート（容量に対する倍率） | 0.5 | 0.05 - 10 |
| CV充電終了の電流比率 | CV充電を終了する電流の閾値（初期電流に対する比率） | 0.05 | 0.01 - 0.5 |
| 時間ステップ (秒) | シミュレーションの時間分解能 | 1.0 | > 0.1 |
| 平滑化係数 | グラフの曲線平滑化の度合い | 0.05 | ≥ 0 |

## 容量維持率の計算方法

容量維持率は以下の方法で計算されます：

1. 各サイクルで放電シミュレーションを実行し、放電容量（Ah）を記録
2. 初回サイクル（サイクル1）の放電容量を基準値（100%）として設定
3. 各サイクルの放電容量を初回サイクルの放電容量で割り、100を掛けて百分率に変換
4. 結果をサイクル数に対してプロット

数式：
```
容量維持率(%) = (サイクルnの放電容量 / 初回サイクルの放電容量) × 100
```

## CSV出力ファイル

プログラムは以下のCSVファイルを生成します：

1. **サイクル概要ファイル** (`{prefix}_summary_{timestamp}.csv`)
   - サイクル番号、容量、内部抵抗、放電容量、容量維持率の概要データ

2. **容量維持率ファイル** (`{prefix}_retention_{timestamp}.csv`)
   - サイクル番号、放電容量、容量維持率のデータ

3. **充電データファイル** (`{prefix}_cycle{n}_charge_{timestamp}.csv`)
   - 各サイクルの充電過程における SOC、容量、電圧データ

4. **放電データファイル** (`{prefix}_cycle{n}_discharge_{timestamp}.csv`)
   - 各サイクルの放電過程における SOC、容量、電圧データ

## 応用例
- 電池の寿命予測と評価
- 異なる使用条件（C-レート、温度など）が容量維持率に与える影響の分析
- 劣化パラメータの最適化による長寿命電池の設計
- 実験データとの比較による劣化モデルの検証
- 電池交換時期の予測と計画
# Flask10X ログとメトリクス（日本語）

最終更新日: 2025-08-24
対象バージョン: Flask10X Steps 1–9 実装版

本書は、Flask10X のログ出力仕様、ローテーション、メトリクスの意味、しきい値、運用時の見方について解説します。

---

## 1. ログ出力の場所と形式

- 出力先: `HomeRaspMod/ModVer/logs/flask10x.log`
- ローテーション: 最大 1MB、5 世代までバックアップ（flask10x.log.1 ～）
- 文字コード: UTF-8
- 形式例:
```
2025-08-24 09:00:01 INFO Starting Flask10X application (threaded dev server)
2025-08-24 09:00:12 INFO /data OK enqueued pressure=1013.2 temperature=25.1 queue_size=3
2025-08-24 09:02:00 WARNING Write queue high watermark reached: 4000/5000
2025-08-24 09:04:30 WARNING Endpoint 'data3' inactive for 145s (threshold 120s)
2025-08-24 09:05:00 ERROR /data2 validation error: {'humidity': 'above maximum 100'}
```

---

## 2. ログレベルの目安

- INFO: 通常動作（起動、受信成功、キュー長情報など）
- WARNING: 注意喚起（キュー高水位、無通信しきい値超過、CSV 書込失敗のリトライなど）
- ERROR: 異常（バリデーション失敗の詳細、書込の最終失敗、予期しない例外）

---

## 3. メトリクス（/metrics）

`GET /metrics` は JSON でランタイム情報を返します。

主要フィールド:
- queue_length: 現在の書込待ちジョブ数（高いほど滞留）
- queue_warn_threshold: WARN を出すしきい値（WRITE_QUEUE_MAXSIZE の 80% が既定）
- write_success_total / write_error_total: ワーカースレッドが更新する成功/失敗の累計
- last_received: 各エンドポイントの最終受信時刻（未受信は null）
- inactivity_seconds: 最終受信からの経過秒（未受信は null）
- inactivity_warn_threshold_sec: 無通信 WARN のしきい値（既定 120 秒）

---

## 4. WARN の読み解き方

- キュー高水位 WARN
  - 原因: POST が多すぎる、あるいはストレージ I/O が遅い
  - 対処: Gunicorn ワーカ/スレッド数を増やす、キューサイズ拡大、高速ストレージへ移行
- 無通信 WARN（特定エンドポイント）
  - 原因: 送信元デバイス停止、ネットワーク断、プログラム停止
  - 対処: 送信側ログ/電源/無線強度の確認、再起動

---

## 5. CSV 書込みの堅牢化（実装要点）

- ファイルごとの Lock（同一ファイルへの同時書込みを排他）
- ヘッダ重複抑止（新規時のみ header）
- 失敗時の短いバックオフリトライ（指数）
- flush + fsync によるディスク耐久性

---

## 6. 運用の定期確認ポイント

- queue_length が慢性的に高くないか
- write_error_total が増加し続けていないか
- inactivity_seconds が長時間のままになっていないか
- ログの WARN/ERROR が多発していないか

---

## 7. 参考: 代表コマンド

```bash
# ヘルス
curl -s http://localhost:8888/healthz

# メトリクス（jq 推奨）
curl -s http://localhost:8888/metrics | jq

# ログ追跡
tail -n 200 -f /home/pi/RPi_Development01/HomeRaspMod/ModVer/logs/flask10x.log
```

---

以上がログとメトリクスの読み方です。閾値の調整は Flask10X.py 冒頭の定数で行ってください。
# Flask10X 概要と構成説明（日本語）

最終更新日: 2025-08-24
対象バージョン: Flask10X Steps 1–9 実装版

本書は、本リポジトリ HomeRaspMod/ModVer に含まれる Flask10X アプリケーションの全体像と内部構成を日本語で解説します。ログ機能、非同期CSV書き込みキュー、メトリクス、稼働モード（開発/本番）などの実装方針とディレクトリ構成、設定値の意味をまとめています。

---

## 1. システム概要

Flask10X は、以下の目的を持つ軽量なデータ受信・保存サーバです。
- 複数のエンドポイント（/data, /data2, /data3, /data4）で JSON を受け、バリデーション後に CSV に追記保存
- 非同期キュー + 専用ワーカースレッドでファイルI/Oを分離し、リクエスト遅延を低減
- ローテーション付きログで運用性を確保
- /healthz と /metrics により死活監視およびランタイム指標を提供
- 開発時は Flask のスレッドサーバ、運用時は Gunicorn + systemd でマルチワーカ運用

---

## 2. ディレクトリ構成（抜粋）

```
HomeRaspMod/ModVer/
├─ Flask10X.py                # サーバ本体（Flaskアプリ）
├─ flask10x.service           # systemd ユニット（本番用の例）
├─ logs/
│   └─ flask10x.log           # ログ（ローテーション対応）
├─ PicodataX.csv              # /data の出力CSV
├─ BedRoomEnv.csv             # /data2 の出力CSV
├─ OutsideEnv.csv             # /data3 の出力CSV
├─ LR_env.csv                 # /data4 の出力CSV
└─ Documentation_JP/
    ├─ 00_概要と構成_JP.md
    ├─ 01_インストール手順_JP.md
    ├─ 02_起動と運用_JP.md
    ├─ 03_API仕様_JP.md
    ├─ 04_ログとメトリクス_JP.md
    └─ 05_トラブルシューティング_JP.md
```

---

## 3. 主要ファイルと役割

- Flask10X.py
  - Flask アプリ本体。エンドポイント定義、入力バリデーション、非同期書き込みキュー、メトリクス、履歴保持などを実装。
  - スレッドセーフな書き込み（ファイルごとの Lock）とリトライ、fsync により CSV の整合性を確保。
- flask10x.service
  - systemd 用ユニットファイルのサンプル。Gunicorn で本番稼働するための設定例。
- logs/flask10x.log
  - RotatingFileHandler により 1MB×5世代のローテーション。起動・リクエスト・警告・エラーを記録。
- 各 CSV ファイル
  - エンドポイントごとに列順を固定化。ヘッダ重複を抑止。

---

## 4. 設定値（Flask10X.py 冒頭の定数）

- PORT: 既定 8888（開発サーバ時のリッスンポート）
- LOG_DIR / LOG_FILE / LOG_MAX_BYTES / LOG_BACKUP_COUNT: ログ出力とローテーション設定
- HISTORY_MAX: /history に表示するメモリ内履歴の上限（deque）
- CSV_PICODATA / CSV_BEDROOM / CSV_OUTSIDE / CSV_LR: CSV 出力先パス
- COLUMNS_*: 各 CSV の列順（固定）
- WRITE_QUEUE_MAXSIZE: 非同期書き込みキューの最大長（既定 5000）
- WRITE_RETRIES / WRITE_BACKOFF_BASE_SEC: 書き込み失敗時のリトライ回数とバックオフ（指数）
- QUEUE_WARN_THRESHOLD: キュー警告しきい値（MAX の 80%）
- INACTIVITY_WARN_SEC: 各エンドポイントの受信停止を警告するまでの無通信秒数（既定 120 秒）

---

## 5. スレッド/コンポーネント構成

- メインスレッド（Flask）
  - リクエスト受信→バリデーション→CSV 書き込みジョブをキューへ投入→即時 200 応答
- CSV Writer ワーカースレッド（daemon）
  - キューを消費し、対象 CSV に排他ロック付きで追記。ヘッダ抑止、リトライ、flush + fsync を実施
  - 成功/失敗カウントをメトリクスに反映
- Metrics Monitor スレッド（daemon）
  - 一定周期でキュー長と無通信時間を確認し、しきい値超過時に WARN をログ出力

---

## 6. 入力バリデーションと正規化

- 共有バリデータ validate_and_normalize() を全エンドポイントで使用
- 数値文字列（例: "1013hPa", "25C"）は単位を除去し float 変換
- 必須フィールド欠落や型不正は 400 として JSON エラー応答（詳細内訳付き）
- エンドポイントごとにスキーマ（最小/最大、型）定義済み

---

## 7. メトリクスと観測性

- /metrics で以下を JSON 返却
  - queue_length / queue_warn_threshold
  - write_success_total / write_error_total
  - last_received（各エンドポイントの最終受信時刻）
  - inactivity_seconds（無通信秒数）
  - inactivity_warn_threshold_sec
- /healthz は 200 OK を常時返却（単純生存確認）

---

## 8. 運用モデル

- 開発モード: Flask 内蔵サーバ（threaded=True）
- 本番モード: Gunicorn（複数ワーカ/スレッド） + systemd 自動再起動

詳細は 02_起動と運用_JP.md を参照してください。

---

## 9. CSV 列定義（固定）

- /data → PicodataX.csv: [current_time, Pressure, Tempereture]
- /data2 → BedRoomEnv.csv: [current_time, CO2, Tempereture, Humidity, Pressure, GasResistance]
- /data3 → OutsideEnv.csv: [current_time, Temperature-outside, Humidity-outside, Pressure-outside, GasResistance-outside]
- /data4 → LR_env.csv: [current_time, CO2, AnalogValue, Voltage, Temperature_DS18B20, Temperature_DHT11, Humidity_DHT11]

---

## 10. セキュリティ/権限の注意

- 本番運用では systemd ユニットの実行ユーザが CSV 出力先とログ出力先に書き込み可能であることを確認
- 外部公開する場合はファイアウォール、リバースプロキシ（必要に応じてTLS）などを検討

---

以上が Flask10X の構成要点です。インストール・起動・API 仕様・運用監視・トラブル対策は、同フォルダ内の他ドキュメントをご参照ください。
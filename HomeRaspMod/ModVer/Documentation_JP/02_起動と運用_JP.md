# Flask10X 起動と運用（日本語）

最終更新日: 2025-08-24
対象バージョン: Flask10X Steps 1–9 実装版

本書は、Flask10X の日常運用（開発モード、本番モード）、稼働確認、ログ確認、メンテナンスについて解説します。

---

## 1. 開発モード（簡易起動）

Flask 内蔵のスレッドサーバで起動します。

```bash
cd /home/pi/RPi_Development01/HomeRaspMod/ModVer
source ~/envmonitor-venv/bin/activate
python3 BackUPFlask10X.py
```

- `threaded=True` で複数リクエストを並列処理
- 書き込みはキューイングされ、専用ワーカースレッドが CSV 追記
- 確認:
  - ヘルス: `curl -s http://localhost:8888/healthz`
  - メトリクス: `curl -s http://localhost:8888/metrics | jq`
  - 履歴: `http://<サーバIP>:8888/history`

停止は Ctrl+C。

---

## 2. 本番モード（Gunicorn + systemd）

### 2.1 ユニット配置と起動

```bash
sudo cp /home/pi/RPi_Development01/HomeRaspMod/ModVer/BackUPflask10x.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable flask10x
sudo systemctl start flask10x
```

- 既定では 2 ワーカ × 2 スレッド
- 必要に応じ `flask10x.service` の `ExecStart` を調整（CPU コア数・I/O 負荷に応じて）

### 2.2 運用コマンド

- 起動: `sudo systemctl start flask10x`
- 停止: `sudo systemctl stop flask10x`
- 再起動: `sudo systemctl restart flask10x`
- ステータス: `systemctl status flask10x`

### 2.3 稼働確認

- `curl -s http://localhost:8888/healthz`
- `curl -s http://localhost:8888/metrics | jq`
- ブラウザで `http://<サーバIP>:8888/history`

---

## 3. ログの確認

- 出力先: `HomeRaspMod/ModVer/logs/flask10x.log`
- ローテーション: 1MB × 5 世代
- 内容: 起動ログ、各エンドポイント INFO、バリデーション ERROR、キュー高水位 WARN、無通信 WARN

### 3.1 tail で追跡

```bash
tail -n 200 -f /home/pi/RPi_Development01/HomeRaspMod/ModVer/logs/flask10x.log
```

---

## 4. バックアップ/メンテナンス

- CSV は追記型のため、定期的なバックアップを推奨
- ログはローテーションされますが、長期運用ではアーカイブ/削除ポリシーを検討
- バージョン更新時は、稼働停止→置換→起動→/healthz で確認の順に実施

---

## 5. パフォーマンス調整の目安

- 高頻度 POST で `queue_length` が慢性的に高い → `WRITE_QUEUE_MAXSIZE` 増加、または Gunicorn のワーカ/スレッド拡張
- ストレージが遅い → 高速媒体、または CSV を別パーティションへ。リトライは既実装。
- エンドポイントが無通信 WARN → 送信元側の健全性を確認（センサー停止・ネットワーク断など）

---

## 6. 停止手順（安全）

- 開発: Ctrl+C
- 本番: `sudo systemctl stop flask10x`
  - 停止指示後、ワーカスレッドはキュー処理分を完了したのちに停止（systemd ではプロセス終了時）

---

## 7. よくある運用上の質問（FAQ）

- Q: ポートを変更したい
  - A: `Flask10X.py` の `PORT` を変更（開発時）。本番は `flask10x.service` の `-b 0.0.0.0:8888` を変更。
- Q: CSV の保存先を変えたい
  - A: `CSV_*` 定数を環境に合わせて修正し、書込権限を付与。
- Q: ログが出ない
  - A: `logs/` に書き込めない権限の可能性。実行ユーザとパスを確認。

---

以上が起動と運用の基本です。API の詳細は「03_API仕様_JP.md」、メトリクスとログの読み方は「04_ログとメトリクス_JP.md」を参照してください。
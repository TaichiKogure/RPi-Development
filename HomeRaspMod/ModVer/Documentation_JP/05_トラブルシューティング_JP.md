# Flask10X トラブルシューティング（日本語）

最終更新日: 2025-08-24
対象バージョン: Flask10X Steps 1–9 実装版

本書は、Flask10X 運用時によくある問題と対処方法をまとめています。ログの読み方、メトリクスの評価、権限や環境に起因するトラブルの切り分けにお役立てください。

---

## 1. サーバが起動しない / 接続できない

- 症状: `curl http://localhost:8888/healthz` で応答がない
- チェック項目:
  - 開発時: 端末に Flask の起動ログが出ているか
  - 本番時: `systemctl status flask10x` で Active になっているか
  - ポート 8888 がファイアウォールで許可されているか
  - `flask10x.service` の `WorkingDirectory`、`ExecStart` のパスが実ファイルに一致しているか

---

## 2. ログが出力されない

- 症状: `logs/flask10x.log` が作成されない/空
- 対処:
  - 実行ユーザ（例: pi）が `HomeRaspMod/ModVer/logs` に書込み可能か
  - ログレベルは INFO で初期化済み。アプリが起動すれば最低限のログは出ます

---

## 3. CSV に書き込まれない

- 症状: 受信に 200 が返るが CSV が増えない
- 確認:
  - `/metrics` の `queue_length` が増え続けていないか（キュー滞留）
  - `write_error_total` が増加していないか（書込エラー）
  - ログに WARNING/ERROR が出ていないか（パス/権限/ディスクフル）
- 対処:
  - CSV ファイル/ディレクトリの書込権限を付与
  - ディスク容量を確保
  - 極端に遅いストレージの使用を避ける

---

## 4. 400 Bad Request（バリデーションエラー）が頻発

- 症状: POST が 400 を返し、エラー詳細が JSON の `details` に出る
- 原因:
  - 必須フィールド欠落
  - 型不正（文字列を数値として解釈できない等）
  - 範囲外の数値
- 対処:
  - 「03_API仕様_JP.md」のスキーマと例を参照し、送信側のフォーマットを修正

---

## 5. 503 queued_failed（キュー満杯）

- 症状: レスポンスが 503 に変化し、`{"status":"queued_failed"}` が返る
- 原因:
  - 受信頻度が高すぎる、または書込みが遅くキューが飽和
- 対処:
  - `WRITE_QUEUE_MAXSIZE` を増やす
  - Gunicorn のワーカ数やスレッド数を増やす
  - CSV を高速なストレージに移す

---

## 6. 無通信 WARN が続く

- 症状: ログに `Endpoint 'dataX' inactive ...` が出続ける
- 原因: 送信元（センサ）側の停止・ハング・ネットワーク断
- 対処:
  - 送信元の電源/ログ/無線状況を確認
  - 一時的な開発中で意図的に停止している場合は無視可（閾値 INACTIVITY_WARN_SEC を延長する手も）

---

## 7. Gunicorn がすぐに落ちる

- 症状: `systemctl status flask10x` で Failed を繰り返す
- チェック:
  - `ExecStart` の Python/パスが存在するか
  - `Flask10X:app` が正しくインポート可能か（WorkingDirectory）
  - 権限エラーで CSV/ログに書けていない可能性

---

## 8. パフォーマンスが出ない

- 症状: レイテンシ増大、キュー長の増加
- 対処:
  - Gunicorn ワーカ数を 2→4+ に、スレッド数も増やす
  - ストレージを高速化
  - ネットワーク遅延が起点なら送信側のレートを調整

---

## 9. 設定変更後の反映

- Flask10X.py の定数変更（PORT 等）は、
  - 開発: プロセス再起動（Ctrl+C → 再起動）
  - 本番: `sudo systemctl restart flask10x`

---

## 10. 追加診断コマンド例

```bash
# プロセス確認
ps aux | grep gunicorn

# ソケット使用状況
ss -tulpn | grep 8888

# ディスク容量
df -h

# 権限
ls -l /home/pi/RPi_Development01/HomeRaspMod/ModVer
```

---

問題が解決しない場合は、ログ（WARN/ERROR）の該当箇所と `/metrics` の値を合わせて調査してください。
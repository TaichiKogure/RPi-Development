# BME680環境データモニター（OLEDディスプレイ付き）

このプロジェクトは、Raspberry Pi Pico、BME680環境センサー、およびSSD1306 OLEDディスプレイを使用した環境データ監視システムを実装します。システムは環境データ（温度、湿度、気圧、ガス抵抗）を継続的に読み取り、スクロールテキストでOLEDスクリーンに表示します。

## 特徴

- 日付と時刻、温度、湿度、絶対湿度、気圧、ガス抵抗を表示
- 温度と相対湿度から絶対湿度を計算
- テキストが右から左へスクロールして読みやすさを向上
- 3行に整理された表示：
  - 上段：日付と時刻
  - 中段：温度、相対湿度、絶対湿度
  - 下段：気圧、ガス抵抗
- 1秒ごとに更新
- LED状態表示
- エラー処理と自動再試行機能

## ハードウェア要件

- Raspberry Pi PicoまたはPico W
- BME680環境センサー
- SSD1306 OLEDディスプレイ（128x64ピクセル）
- ジャンパーワイヤー
- ブレッドボード（オプション）
- USBケーブル（電源供給とプログラミング用）

## ピン接続

### BME680センサー（I2C接続）

| BME680ピン | Raspberry Pi Picoピン |
|------------|----------------------|
| VCC        | 3.3V（ピン36）        |
| GND        | GND（ピン38）         |
| SCL        | GP1（ピン2）          |
| SDA        | GP0（ピン1）          |

### SSD1306 OLEDディスプレイ（SPI接続）

| OLEDディスプレイピン | Raspberry Pi Picoピン |
|------------------|----------------------|
| VCC              | 3.3V（ピン36）        |
| GND              | GND（ピン38）         |
| DIN（MOSI）       | GP3（ピン5）          |
| CLK（SCK）        | GP2（ピン4）          |
| CS               | GP6（ピン9）          |
| DC               | GP4（ピン6）          |
| RST              | GP5（ピン7）          |

## インストール

### 1. Raspberry Pi PicoにMicroPythonをインストール

1. [公式ウェブサイト](https://micropython.org/download/rp2-pico/)からRaspberry Pi Pico用の最新のMicroPythonファームウェア（.uf2ファイル）をダウンロードします。
2. BOOTSELボタンを押しながらPicoをコンピュータに接続します。
3. 接続後にボタンを離します。
4. PicoがUSBドライブとして表示されます。
5. ダウンロードした.uf2ファイルをPicoドライブにコピーします。
6. Picoは自動的に再起動し、MicroPythonを実行します。

### 2. 必要なライブラリをインストール

1. このリポジトリから以下のファイルをダウンロードします：
   - `bme680.py` - BME680センサー用ドライバ
   - `ssd1306.py` - SSD1306 OLEDディスプレイ用ドライバ
   - `bme680_oled_monitor.py` - メインプログラム

2. Thonny IDEまたは他のMicroPython IDEを使用して：
   - Raspberry Pi Picoに接続します
   - `bme680.py`と`ssd1306.py`ファイルをPicoにアップロードします
   - `bme680_oled_monitor.py`ファイルをPicoにアップロードします

### 3. プログラムを実行

1. 上記のピン接続に従って、BME680センサーとSSD1306 OLEDディスプレイをRaspberry Pi Picoに接続します。
2. USB経由でPicoに電源を供給します。
3. `bme680_oled_monitor.py`ファイルを実行します。
4. プログラムはハードウェアを初期化し、環境データをOLEDスクリーンに表示し始めます。

## 使用方法

プログラムが実行されると、以下の動作をします：

1. BME680センサーとSSD1306ディスプレイを初期化
2. 1秒ごとに環境データを読み取り
3. スクロールテキストでOLEDスクリーンにデータを表示
4. デバッグ用にシリアルコンソールにデータを出力

オンボードLEDはセンサー読み取り中やエラー状態を示すために点滅します。

プログラムを停止するには、シリアルコンソールでCtrl+Cを押すか、Picoの電源を切断します。

## カスタマイズ

`bme680_oled_monitor.py`ファイル内の以下のパラメータを変更することでプログラムをカスタマイズできます：

- `I2C_SCL_PIN`と`I2C_SDA_PIN`：BME680センサー用のI2Cピンを変更
- `SPI_SCK_PIN`、`SPI_MOSI_PIN`、`SPI_DC_PIN`、`SPI_RST_PIN`、`SPI_CS_PIN`：SSD1306ディスプレイ用のSPIピンを変更
- `TOP_ROW_HEIGHT`、`MIDDLE_ROW_HEIGHT`、`BOTTOM_ROW_HEIGHT`：行の高さを調整
- スクロール速度：`ScrollText`コンストラクタの`speed`パラメータを変更

## トラブルシューティング

### データが表示されない

- Pico、BME680センサー、SSD1306ディスプレイ間のすべての接続を確認してください
- BME680センサーが検出されていることを確認してください（シリアル出力で「I2C devices found」を確認）
- BME680センサーの両方のI2Cアドレス（0x76と0x77）を試してください

### ディスプレイの問題

- SSD1306ディスプレイが正しく接続されていることを確認してください
- SPI接続を確認してください
- ディスプレイが暗すぎるか明るすぎる場合は、コントラスト設定を調整してください

### センサー読み取りエラー

- BME680センサーが正しく接続されていることを確認してください
- I2C接続を確認してください
- センサーに正しく電力が供給されていることを確認してください

## プログラム構造の説明

### メインプログラム（bme680_oled_monitor.py）

このプログラムは以下の主要なコンポーネントで構成されています：

1. **初期化部分**：
   - 必要なライブラリとドライバのインポート
   - ピン定義とディスプレイ設定
   - LEDセットアップ

2. **絶対湿度計算関数**：
   - 温度と相対湿度から絶対湿度を計算
   - 入力値の検証と例外処理

3. **スクロールテキストクラス**：
   - テキストを右から左へスクロールさせる機能
   - 画面端でのテキスト折り返し処理
   - 表示位置と速度の制御

4. **エラー処理関数**：
   - エラーメッセージの表示
   - LEDによるフィードバック
   - 自動再試行機能

5. **メイン関数**：
   - ハードウェアの初期化（I2C、SPI、センサー、ディスプレイ）
   - センサーデータの読み取りと検証
   - ディスプレイの更新
   - エラー処理と回復メカニズム

6. **メインループ**：
   - 継続的なデータ読み取りと表示更新
   - メモリ管理
   - キーボード割り込み処理

### 改良点

最新バージョンでは以下の改良が施されています：

1. **メモリ効率**：
   - スクロールテキストオブジェクトをループ外で作成し、メモリ使用量を削減
   - 定期的なガベージコレクション

2. **エラー処理の強化**：
   - センサー読み取りの堅牢なエラーチェック
   - 前回の有効な読み取り値またはデフォルト値へのフォールバック
   - 適切なディスプレイクリーンアップ

3. **データ検証**：
   - センサー読み取り値と絶対湿度計算の検証
   - 無効なデータの処理

4. **状態保存**：
   - 最後の有効な読み取り値を属性として保存
   - センサー読み取りエラー時の連続性確保

## ライセンス

このプロジェクトはMITライセンスの下で提供されています - 詳細はLICENSEファイルを参照してください。

## 謝辞

- BME680ドライバはAdafruit BME680ライブラリをベースにしています
- SSD1306ドライバはMicroPython SSD1306ライブラリをベースにしています
# Raspberry Pi OLED ディスプレイ情報システム - バージョン 3.1

## 更新内容

このバージョンでは、3Dアニメーションが終了せずに繰り返し表示され続け、時間やCPU情報などのテキスト表示に戻らない問題を修正しました。

## 問題の詳細

バージョン2.1では、以下の問題が発生していました：

- 3Dアニメーションが表示された後、プログラムがテキスト表示（日時、CPU使用率、温度情報）に戻らず、3Dアニメーションの表示が無限に繰り返される
- この問題により、ユーザーは最新の時間やシステム情報を確認できなくなる

## 原因

問題の主な原因は以下の点にありました：

1. アニメーション関数（`draw_3d_animation()`）が実行中かどうかを追跡する仕組みがなかった
2. アニメーション関数内で例外が発生した場合の適切なエラーハンドリングが不足していた
3. アニメーションの実行時間に上限がなく、タイミングの問題で無限ループに陥る可能性があった

## 修正内容

バージョン3.1では、以下の改善を実装しました：

1. **アニメーション実行状態の追跡**
   - グローバル変数 `animation_running` を追加して、アニメーションが実行中かどうかを追跡
   - メインループでこのフラグをチェックし、アニメーション実行中は新しいテキスト表示処理を開始しない

2. **例外処理の強化**
   - `draw_3d_animation()` 関数に `try-except-finally` ブロックを追加
   - `finally` ブロックで確実に `animation_running` フラグをリセット
   - 様々な例外に対応するエラーハンドリングを追加

3. **安全対策**
   - アニメーションの最大実行時間 (`max_animation_time`) を設定
   - この時間を超えると、アニメーションを強制終了してテキスト表示に戻る
   - スクロール処理中にアニメーションが開始された場合、スクロールを中断する処理を追加

4. **デバッグ機能**
   - デバッグモードを追加し、プログラムの実行状態を詳細に追跡可能に
   - 重要なポイントでデバッグメッセージを出力

## 使用方法

バージョン2.1と同様に使用できます。変更点は内部的なものであり、ユーザーインターフェースや基本機能は変わっていません。

```bash
python3 DispVer3.1.py
```

## デバッグモード

デバッグ情報を表示したい場合は、プログラム内の `DEBUG` 変数を `True` に設定してください（デフォルトで有効）。

```python
# デバッグモード（詳細なログ出力）
DEBUG = True
```

デバッグモードを無効にするには、この値を `False` に変更します。

## 設定パラメータ

新しく追加された設定パラメータ：

```python
# 3Dアニメーション設定
animation_duration = 3.0  # アニメーション表示時間（秒）
animation_frames = 120    # アニメーションのフレーム数
max_animation_time = 5.0  # アニメーションの最大実行時間（秒）- 安全対策
```

`max_animation_time` は、アニメーションが何らかの理由で正常に終了しない場合の安全対策として機能します。この時間を超えると、アニメーションは強制的に終了し、テキスト表示に戻ります。

## 注意事項

- このプログラムは Raspberry Pi と SPI接続の128x64 OLEDディスプレイ（SSD1306コントローラ使用）で動作確認しています
- 必要なライブラリ（adafruit-blinka, adafruit-circuitpython-ssd1306, pillow, psutil, numpy）がインストールされていることを確認してください

---

更新日: 2025年7月26日
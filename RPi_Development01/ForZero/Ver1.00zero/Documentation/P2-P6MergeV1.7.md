# P2-P6マージ 変更ログ Ver1.7

## 概要
このアップデートでは、Raspberry Pi Zero 2W（P1）を中央ハブとして、最大5つのセンサーノード（P2〜P6）からの環境データを収集、保存、表示する機能を追加しました。以前のバージョンでは、P2とP3の2つのセンサーノードのみをサポートしていましたが、このアップデートにより、P4、P5、P6の3つの追加センサーノードをサポートするようになりました。

## 変更内容

### データ収集モジュール
1. **CSVManager**
   - P2とP3だけでなく、P4、P5、P6のデータも処理できるように更新
   - 以下のメソッドを更新:
     - `_init_csv_files`: P4、P5、P6のCSVファイルを初期化
     - `rotate_csv_files`: P4、P5、P6のCSVファイルをローテーション
     - `cleanup_old_files`: P4、P5、P6の古いCSVファイルをクリーンアップ
     - `close`: P4、P5、P6のCSVファイルを閉じる

2. **設定ファイル**
   - `config.py`に`rawdata_p2_dir`と`rawdata_p3_dir`を追加
   - `MONITOR_CONFIG`にP2とP3のエントリを追加
   - `ensure_data_directories`関数を更新してP2とP3のディレクトリも作成するように変更

### Webインターフェース
1. **データ取得**
   - `get_historical_data`メソッドを更新してP4、P5、P6のデータも取得できるように変更

2. **グラフ作成**
   - `create_time_series_graph`メソッドを更新:
     - メソッドシグネチャに`show_p4`、`show_p5`、`show_p6`パラメータを追加
     - P4、P5、P6のタイムスタンプ処理を追加
     - P4、P5、P6のデータログを追加
     - P4、P5、P6のデータ検証とグラフ作成を追加
   - `create_dashboard_graphs`メソッドを更新:
     - メソッドシグネチャに`show_p4`、`show_p5`、`show_p6`パラメータを追加
     - パラメータを`create_time_series_graph`に渡すように変更

3. **APIエンドポイント**
   - `/dashboard`ルートを更新:
     - `show_p4`、`show_p5`、`show_p6`パラメータを取得
     - パラメータをテンプレートに渡すように変更
   - `/api/graphs`ルートを更新:
     - `show_p4`、`show_p5`、`show_p6`パラメータを取得
     - パラメータを`create_dashboard_graphs`に渡すように変更
   - `/api/export/<device_id>`ルートを更新:
     - `device_id`チェックにP4、P5、P6を追加
   - `/api/device/<device_id>`ルートを更新:
     - `device_id`チェックにP4、P5、P6を追加

## 使用方法
このアップデート後、P1はP2〜P6の最大5つのセンサーノードからデータを収集できるようになりました。Webインターフェースでは、各センサーノードのデータを個別に表示または非表示にすることができます。

### センサーノードの設定
P4、P5、P6のセンサーノードは、P2とP3と同じ方法で設定します:
1. デバイスIDを適切に設定（"P4"、"P5"、または"P6"）
2. WiFi SSIDを"RaspberryPi5_AP_Solo2"に設定
3. WiFiパスワードを"raspberry"に設定
4. サーバーIPを"192.168.0.2"に設定
5. サーバーポートを5000に設定

### Webインターフェースの使用
Webインターフェースでは、以下の操作が可能です:
1. ダッシュボードページで、表示するセンサーノード（P2〜P6）を選択
2. 表示するデータの期間（日数）を選択
3. 各環境パラメータ（温度、湿度、気圧など）のグラフを表示
4. 選択したセンサーノードのデータをCSVファイルとしてエクスポート

## 注意事項
- P4、P5、P6のセンサーノードを使用するには、それぞれのデバイスを適切に設定し、P1のWiFiネットワークに接続する必要があります。
- P1のデータディレクトリ（/var/lib/raspap_solo/data）に、各センサーノード用のディレクトリ（RawData_P2〜RawData_P6）が自動的に作成されます。
- 既存のP2とP3の設定は変更されていないため、これらのデバイスは引き続き使用できます。

## 今後の予定
- センサーノード間の接続品質のモニタリング機能の強化
- データ分析機能の追加
- アラート機能の実装
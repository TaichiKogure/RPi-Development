# Raspberry Pi 5とPico 2Wによるスタンドアロン環境データ測定システム - アーキテクチャ概要

**バージョン: 1.0.0**

## システムアーキテクチャ

このドキュメントでは、Raspberry Pi 5とPico 2Wによるスタンドアロン環境データ測定システムのアーキテクチャ概要を説明します。

### 1. システムコンポーネント

システムは以下のコンポーネントで構成されています：

1. **Raspberry Pi 5 (P1)** - 中央ハブとして機能し、以下を行います：
   - P4、P5、P6用のWiFiアクセスポイントとして機能
   - センサーノードから環境データを収集・保存
   - データ可視化用のWebインターフェースを提供
   - センサーノードとの接続品質を監視

2. **Raspberry Pi Pico 2W (P4, P5, P6)** - センサーノードとして機能し、以下を行います：
   - BME680センサーを使用して環境データを収集
   - MH-Z19Bセンサーを使用してCO2レベルを測定
   - WiFi経由でデータをP1に送信
   - エラーや接続問題が発生した場合に自動再起動

3. **センサー**:
   - BME680 - 温度、湿度、気圧、ガスパラメータを測定
   - MH-Z19B - CO2濃度を測定

### 2. ソフトウェアアーキテクチャ

#### 2.1 P1 (Raspberry Pi 5) ソフトウェア

P1ソフトウェアはいくつかのモジュールに分かれています：

1. **アクセスポイントセットアップ** (`ap_setup`)
   - Raspberry Pi 5をWiFiアクセスポイントとして構成
   - センサーノードにIPアドレスを割り当てるためのDHCPサーバーを設定
   - ネットワークインターフェースを管理

2. **データ収集** (`data_collection`)
   - HTTP経由でセンサーノードからデータを受信
   - 受信データを検証・処理
   - データをCSVファイルに保存
   - データアクセス用のAPIエンドポイントを提供

3. **Webインターフェース** (`web_interface`)
   - データ可視化用のWebベースユーザーインターフェースを提供
   - リアルタイムおよび履歴データを表示
   - CSV形式でのデータダウンロードを可能に
   - センサーノードの接続状態を表示

4. **接続モニター** (`connection_monitor`)
   - WiFi信号強度、ping時間、ノイズレベルを監視
   - センサーノードとの接続品質を追跡
   - 接続状態用のAPIエンドポイントを提供

#### 2.2 P4, P5, P6 (Raspberry Pi Pico 2W) ソフトウェア

センサーノードソフトウェアはいくつかのモジュールに分かれています：

1. **センサードライバー** (`sensor_drivers`)
   - `bme680.py` - BME680センサー用ドライバー
   - `mhz19c.py` - MH-Z19C CO2センサー用ドライバー

2. **データ送信** (`data_transmission`)
   - `P4_wifi_client_debug.py` / `P5_wifi_client_debug.py` / `P6_wifi_client_debug.py` - P1に接続するためのWiFiクライアント
   - `wifi_client.py` - WiFiクライアントへの簡易インターフェース
   - P1へのデータ送信を処理

3. **エラー処理** (`error_handling`)
   - `P4_watchdog_debug.py` / `P5_watchdog_debug.py` / `P6_watchdog_debug.py` - 自動再起動用のウォッチドッグタイマー
   - `watchdog.py` - ウォッチドッグへの簡易インターフェース
   - エラーのログ記録と回復処理

4. **メインプログラム** (`main.py`)
   - センサー、WiFi、ウォッチドッグを初期化
   - センサーからデータを収集
   - データをP1に送信
   - エラー回復を処理

### 3. データフロー

1. **センサーデータ収集**
   - P4、P5、P6がBME680およびMH-Z19Cセンサーから環境データを収集
   - データは一定間隔（デフォルト：30秒）で収集

2. **データ送信**
   - P4、P5、P6がP1のWiFiアクセスポイントに接続
   - データはHTTP POSTリクエストを介してP1に送信
   - 各送信にはデバイスID、タイムスタンプ、センサー読み取り値が含まれる

3. **データ保存**
   - P1がデータを受信し検証
   - データはデバイスと日付ごとに整理されたCSVファイルに保存
   - 各デバイスの固定CSVファイルが簡単にアクセスできるよう維持

4. **データ可視化**
   - P1のWebインターフェースがCSVファイルからデータを読み取り
   - データは時系列グラフとして表示
   - リアルタイムデータは自動的に更新
   - 履歴データは閲覧およびダウンロード可能

### 4. ネットワークアーキテクチャ

1. **WiFiアクセスポイント**
   - P1がSSID "RaspberryPi5_AP_Solo"のWiFiネットワークを作成
   - P4、P5、P6がこのネットワークに接続
   - IPアドレスは192.168.0.50〜192.168.0.150の範囲で割り当て
   - P1のIPアドレスは192.168.0.1

2. **インターネット接続**
   - P1はUSB WiFiドングルを介してインターネットに接続可能
   - これにより、デュアルWiFi機能が可能に：
     - センサーノード用の内部ネットワーク
     - インターネットアクセス用の外部ネットワーク

3. **接続モニタリング**
   - P1がP4、P5、P6との接続品質を監視
   - 指標には信号強度、ping時間、ノイズレベルが含まれる
   - これによりデバイスの物理的な配置の最適化が可能

### 5. エラー処理と回復

1. **センサーノードの回復**
   - P4、P5、P6はシステムフリーズを検出するためのウォッチドッグタイマーを使用
   - センサーエラーやデータ収集失敗時に自動再起動
   - 再起動後の自動WiFi再接続

2. **データ収集の回復**
   - P1は接続切断を適切に処理
   - 一部のセンサーノードがオフラインでも動作継続
   - トラブルシューティング用にエラーをログ記録

### 6. セキュリティ考慮事項

1. **WiFiセキュリティ**
   - WiFiネットワークはWPA2で保護
   - デフォルトパスワードはセットアップ時に変更すべき

2. **データセキュリティ**
   - データはP1にローカルに保存
   - 外部サーバーにデータは送信されない

### 7. スケーラビリティ

システムは拡張性を考慮して設計されています：

- 追加のセンサーノードを追加可能
- 異なるタイプのセンサーを統合可能
- データストレージと可視化を拡張可能

### 8. 将来の拡張

将来の拡張可能性には以下が含まれます：

- 追加センサータイプのサポート
- 高度なデータ分析とアラート機能
- VPN経由のリモートアクセス
- データバックアップとリモート監視用のクラウド統合
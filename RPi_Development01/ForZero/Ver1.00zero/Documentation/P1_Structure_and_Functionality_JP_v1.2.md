# P1 フォルダ構造と機能説明 (Ver1.2)

このドキュメントでは、P1（Raspberry Pi Zero 2W）のソフトウェア構造と機能について説明します。Ver1.2では、Raspberry Pi Zero 2Wの限られたリソースで効率的に動作するように最適化されています。

## 目次

1. [概要](#概要)
2. [フォルダ構造](#フォルダ構造)
3. [主要コンポーネント](#主要コンポーネント)
   - [アクセスポイントセットアップ](#アクセスポイントセットアップ)
   - [データ収集](#データ収集)
   - [Webインターフェース](#webインターフェース)
   - [接続モニター](#接続モニター)
4. [Ver1.2での最適化](#ver12での最適化)
5. [起動方法](#起動方法)
6. [トラブルシューティング](#トラブルシューティング)

## 概要

P1（Raspberry Pi Zero 2W）は、環境データ測定システムの中心ハブとして機能します。主な役割は以下の通りです：

- P4、P5、P6のセンサーノードのためのWiFiアクセスポイントとして機能
- センサーノードから環境データを収集して保存
- データ可視化のためのWebインターフェースを提供
- センサーノードとの接続品質をモニタリング

Ver1.2では、Raspberry Pi Zero 2Wの限られたリソースで効率的に動作するように最適化されています。特に、処理の間に休止時間を追加し、データ受信頻度やターミナル更新頻度を減らし、Webインターフェースをテキストのみの表示に簡略化しています。

## フォルダ構造

P1のソフトウェアは以下のフォルダ構造で整理されています：

```
p1_software_solo405/
├── ap_setup/                # アクセスポイント設定
│   └── P1_ap_setup_solo.py  # アクセスポイント設定スクリプト
├── connection_monitor/      # 接続モニター
│   ├── api/                 # API関連
│   ├── measurements/        # 測定関連
│   ├── utils/               # ユーティリティ
│   ├── config.py            # 設定ファイル
│   ├── main.py              # メインエントリーポイント
│   ├── monitor.py           # モニター実装
│   └── monitor_v1.2.py      # 最適化されたモニター実装（Ver1.2）
├── data_collection/         # データ収集
│   ├── api/                 # API関連
│   ├── network/             # ネットワーク関連
│   ├── processing/          # データ処理
│   ├── storage/             # データ保存
│   ├── config.py            # 設定ファイル
│   ├── main.py              # メインエントリーポイント
│   ├── P1_data_collector_solo.py      # データコレクター実装
│   └── P1_data_collector_solo_v1.2.py # 最適化されたデータコレクター実装（Ver1.2）
├── web_interface/           # Webインターフェース
│   ├── api/                 # API関連
│   ├── data/                # データ関連
│   ├── static/              # 静的ファイル
│   ├── templates/           # HTMLテンプレート
│   │   ├── dashboard.html   # ダッシュボードテンプレート
│   │   ├── dashboard_text_only.html # テキストのみのダッシュボードテンプレート（Ver1.2）
│   │   └── index.html       # インデックスページテンプレート
│   ├── utils/               # ユーティリティ
│   ├── visualization/       # 可視化関連
│   ├── config.py            # 設定ファイル
│   ├── main.py              # メインエントリーポイント
│   ├── P1_app_simple.py     # シンプルなWebアプリ実装
│   └── P1_app_simple_v1.2.py # 最適化されたWebアプリ実装（Ver1.2）
└── start_p1_solo.py         # P1起動スクリプト
```

## 主要コンポーネント

### アクセスポイントセットアップ

**目的**: P4、P5、P6のセンサーノードのためのWiFiアクセスポイントを設定します。

**主要ファイル**:
- `P1_ap_setup_solo.py`: アクセスポイントを設定するスクリプト

**機能**:
- Raspberry Pi Zero 2WをWiFiアクセスポイントとして設定
- DHCPサーバーの設定
- DNSサーバーの設定
- IPフォワーディングの設定

### データ収集

**目的**: センサーノードから環境データを収集し、保存します。

**主要ファイル**:
- `P1_data_collector_solo.py`: 元のデータコレクター実装
- `P1_data_collector_solo_v1.2.py`: 最適化されたデータコレクター実装（Ver1.2）

**機能**:
- センサーノードからのデータ受信
- データの検証と処理
- CSVファイルへのデータ保存
- データへのAPIアクセスの提供

**Ver1.2での最適化**:
- データ受信チャンク間に休止時間を追加（100ms）
- ログ記録頻度を削減（5回に1回のみログを記録）
- メインサーバーループに休止時間を追加
- APIルートにレート制限を実装
- ファイル操作後に休止時間を追加

### Webインターフェース

**目的**: 収集したデータを表示するためのWebインターフェースを提供します。

**主要ファイル**:
- `P1_app_simple.py`: 元のWebアプリ実装
- `P1_app_simple_v1.2.py`: 最適化されたWebアプリ実装（Ver1.2）
- `dashboard.html`: 元のダッシュボードテンプレート
- `dashboard_text_only.html`: テキストのみのダッシュボードテンプレート（Ver1.2）

**機能**:
- 最新のセンサーデータの表示
- 接続状態の表示
- データのエクスポート機能
- 履歴データの表示

**Ver1.2での最適化**:
- グラフ描画を削除し、テキストのみの表示に簡略化
- 自動更新間隔を10秒から30秒に増加
- データ読み込みをオンデマンドに変更（ボタンクリックで読み込み）
- 不要なJavaScriptライブラリの読み込みを削除

### 接続モニター

**目的**: センサーノードとの接続品質をモニタリングします。

**主要ファイル**:
- `monitor.py`: 元のモニター実装
- `monitor_v1.2.py`: 最適化されたモニター実装（Ver1.2）

**機能**:
- センサーノードとの信号強度の測定
- ノイズレベルの測定
- Ping時間の測定
- 接続状態の監視

**Ver1.2での最適化**:
- モニタリング間隔を5秒から30秒に増加
- ログ記録頻度を削減（5回に1回のみログを記録）
- 測定間に休止時間を追加（100ms）
- 履歴サイズを100から60に削減
- Ping回数を5から3に削減
- Pingタイムアウトを2秒から1秒に削減

## Ver1.2での最適化

Ver1.2では、Raspberry Pi Zero 2Wの限られたリソースで効率的に動作するように以下の最適化が行われています：

1. **処理間の休止時間の追加**:
   - データ受信チャンク間に休止時間を追加（100ms）
   - メインループに休止時間を追加
   - 測定間に休止時間を追加
   - ファイル操作後に休止時間を追加

2. **データ受信頻度の削減**:
   - モニタリング間隔を5秒から30秒に増加
   - Webインターフェースの自動更新間隔を10秒から30秒に増加

3. **ターミナル更新頻度の削減**:
   - ログ記録頻度を削減（5回に1回のみログを記録）

4. **Webインターフェースの簡略化**:
   - グラフ描画を削除し、テキストのみの表示に簡略化
   - 不要なJavaScriptライブラリの読み込みを削除
   - データ読み込みをオンデマンドに変更

5. **その他の最適化**:
   - 履歴サイズの削減
   - Ping回数の削減
   - Pingタイムアウトの削減
   - APIルートにレート制限を実装

## 起動方法

P1を起動するには、以下のコマンドを実行します：

```bash
cd /path/to/RPi_Development01/ForZero/Ver1.00zero
python3 p1_software_Zero/start_p1_solo.py
```

Ver1.2の最適化されたコンポーネントを使用するには、以下のように起動スクリプトを修正する必要があります：

1. `P1_data_collector_solo.py`を`P1_data_collector_solo_v1.2.py`に置き換え
2. `monitor.py`を`monitor_v1.2.py`に置き換え
3. `P1_app_simple.py`を`P1_app_simple_v1.2.py`に置き換え
4. `dashboard.html`を`dashboard_text_only.html`に置き換え

## トラブルシューティング

### 一般的な問題

1. **P1が起動しない**:
   - ログファイルを確認: `/var/log/data_collector_solo.log`, `/var/log/wifi_monitor_solo.log`, `/var/log/web_interface_solo.log`
   - 必要なパッケージがインストールされているか確認: `pip3 list`
   - 権限を確認: `sudo`で実行してみる

2. **センサーノードからデータが受信されない**:
   - センサーノードがオンラインか確認: `ping 192.168.0.50`（P4の場合）
   - アクセスポイントが正しく設定されているか確認: `sudo systemctl status hostapd`
   - ファイアウォール設定を確認: `sudo iptables -L`

3. **Webインターフェースにアクセスできない**:
   - Webサーバーが実行されているか確認: `ps aux | grep flask`
   - ポートが開いているか確認: `sudo netstat -tulpn | grep 80`
   - ブラウザのキャッシュをクリア

4. **接続モニターが動作しない**:
   - 必要なパッケージがインストールされているか確認: `pip3 list`
   - ログファイルを確認: `/var/log/wifi_monitor_solo.log`
   - 権限を確認: `sudo`で実行してみる

### ログファイル

問題が発生した場合は、以下のログファイルを確認してください：

- データ収集: `/var/log/data_collector_solo.log`
- 接続モニター: `/var/log/wifi_monitor_solo.log`
- Webインターフェース: `/var/log/web_interface_solo.log`

### サポート

問題が解決しない場合は、以下の情報を含めて開発者に連絡してください：

1. 発生している問題の詳細な説明
2. 関連するログファイルの内容
3. 使用しているRaspberry Piのモデルとバージョン
4. 実行しているコマンドと出力
# Raspberry Pi 5 統合起動スクリプト Ver2.0 ガイド

## 概要

`start_p1_solo.py` は、Raspberry Pi 5（P1）の環境データ測定システムのすべての必要なサービスを起動するための統合スクリプトです。このスクリプトは、システム起動時に実行されるように設計されており、すべてのサービスが正常に動作していることを確認します。

Ver2.0では、BME680センサーのみをサポートし、CO2センサー（MH-Z19B）のサポートを削除しました。また、システムの安定性と信頼性を向上させるために、リソース監視や拡張されたリスタートメカニズムなどの機能が追加されています。

## 主な機能

1. **アクセスポイントのセットアップ**
   - Raspberry Pi 5をWiFiアクセスポイントとして設定
   - P4、P5、P6デバイスからの接続を可能にする

2. **データ収集サービス**
   - P4、P5、P6デバイスからのBME680センサーデータを受信
   - データを検証し、CSVファイルに保存
   - 絶対湿度を計算

3. **Webインターフェース**
   - 収集したデータをブラウザで表示
   - テキスト形式でデータを表示（グラフなし）
   - データのエクスポート機能

4. **接続モニター**
   - P4、P5、P6デバイスとの接続状態を監視
   - 信号強度、ノイズレベル、pingタイムなどを表示

5. **拡張機能（Ver2.0で追加）**
   - システムリソース（CPU、メモリ）の監視
   - 指数バックオフによるサービスの再起動
   - 最大再起動試行回数を超えた場合のシステム再起動
   - systemdサービスの作成（自動起動用）
   - サービス起動間の遅延によるリソース競合の軽減

## Ver2.0での変更点

1. **CO2センサー機能の無効化**
   - BME680センサーのみをサポート
   - データ収集スクリプトからCO2関連のコードをコメントアウト
   - CSVファイル構造からCO2列を削除

2. **リソース監視の追加**
   - psutilを使用したCPUとメモリの使用率の監視
   - 設定されたしきい値を超えた場合の警告ログ

3. **拡張されたリスタートメカニズム**
   - 指数バックオフによるサービスの再起動
   - 最大再起動試行回数を超えた場合のシステム再起動
   - 再起動間の最小時間間隔の設定

4. **systemdサービスの作成機能**
   - システム起動時に自動的に起動するためのsystemdサービスファイルの作成
   - `--create-service`オプションで有効化

5. **サービス起動間の遅延**
   - リソース競合を軽減するためのサービス起動間の遅延（5秒）
   - サービスの初期化時間の確保

## 使用方法

### 基本的な起動

```bash
sudo ~/envmonitor-venv/bin/python3 start_p1_solo.py
```

### コマンドラインオプション

- `--data-dir DIR`: データを保存するディレクトリ（デフォルト: /var/lib/raspap_solo/data）
- `--web-port PORT`: Webインターフェースのポート（デフォルト: 80）
- `--api-port PORT`: データAPIのポート（デフォルト: 5001）
- `--monitor-port PORT`: 接続モニターAPIのポート（デフォルト: 5002）
- `--monitor-interval SEC`: モニタリング間隔（秒）（デフォルト: 30）
- `--interface IFACE`: 監視するWiFiインターフェース（デフォルト: wlan0）
- `--create-service`: 自動起動用のsystemdサービスを作成

### systemdサービスの作成

システム起動時に自動的に起動するようにするには、以下のコマンドを実行します：

```bash
sudo ~/envmonitor-venv/bin/python3 start_p1_solo.py --create-service
```

これにより、`/etc/systemd/system/p1-environmental-monitor.service`にsystemdサービスファイルが作成され、有効化されます。

## 設定パラメータ

主な設定パラメータは以下の通りです：

- `monitor_interval`: モニタリング間隔（秒）（デフォルト: 30）
- `max_restart_attempts`: 最大再起動試行回数（デフォルト: 5）
- `restart_backoff_factor`: 再起動バックオフ係数（デフォルト: 1.5）
- `initial_restart_delay`: 初期再起動遅延（秒）（デフォルト: 5）
- `memory_threshold`: メモリ使用率しきい値（%）（デフォルト: 80）
- `cpu_threshold`: CPU使用率しきい値（%）（デフォルト: 80）
- `system_check_interval`: システムリソースチェック間隔（秒）（デフォルト: 60）
- `process_monitor_interval`: プロセスモニタリング間隔（秒）（デフォルト: 30）

## 注意事項

1. このスクリプトは、仮想環境（`~/envmonitor-venv/`）のPythonインタプリタを使用して実行する必要があります。
2. root権限（sudo）で実行する必要があります。
3. システムリソース監視を有効にするには、psutilモジュールをインストールする必要があります：
   ```bash
   ~/envmonitor-venv/bin/pip install psutil
   ```
4. Ver2.0ではBME680センサーのみをサポートし、CO2センサー（MH-Z19B）はサポートしていません。

## トラブルシューティング

1. **サービスが起動しない場合**
   - ログファイル（`/var/log/p1_startup_solo.log`）を確認
   - 必要なPythonモジュールがインストールされているか確認
   - 権限の問題がないか確認

2. **サービスが頻繁に再起動する場合**
   - ログファイルでエラーメッセージを確認
   - システムリソース（CPU、メモリ）の使用率を確認
   - 設定パラメータ（特に`monitor_interval`と`restart_backoff_factor`）を調整

3. **データが収集されない場合**
   - P4、P5、P6デバイスが正常に動作しているか確認
   - WiFi接続が正常か確認
   - データディレクトリの権限を確認

## ログファイル

- メインログ: `/var/log/p1_startup_solo.log`
- データ収集ログ: `/var/log/data_collector_solo.log`
- Webインターフェースログ: `/var/log/web_interface_simple.log`
- 接続モニターログ: `/var/log/wifi_monitor_solo.log`

これらのログファイルを確認することで、問題の診断に役立ちます。
# データ収集モジュールガイド

## 概要
データ収集モジュールは、Raspberry Pi 5（P1）がP2、P3、P4、P5、P6デバイスのBME680センサーからデータを収集、保存、処理するための機能を提供します。Ver2.0では、BME680センサーのみをサポートし、CO2センサー（MH-Z19C）はサポートしていません。

## ディレクトリ構造
データ収集モジュールは以下のディレクトリ構造で構成されています：

```
data_collection/
├── api/                  # API サーバー関連のコード
│   ├── routes.py         # API ルートハンドラ
│   ├── routes_updated.py # Ver2.0用に更新されたAPI ルートハンドラ
│   ├── server.py         # API サーバー
│   └── __init__.py       # パッケージ初期化ファイル
├── network/              # ネットワーク通信関連のコード
│   ├── server.py         # ソケットサーバー
│   └── __init__.py       # パッケージ初期化ファイル
├── processing/           # データ処理関連のコード
│   ├── calculation.py    # 計算関数（例：絶対湿度）
│   ├── validation.py     # データ検証関数
│   ├── validation_updated.py # Ver2.0用に更新されたデータ検証関数
│   └── __init__.py       # パッケージ初期化ファイル
├── storage/              # データ保存関連のコード
│   ├── csv_manager.py    # CSVファイル管理
│   ├── csv_manager_updated.py # Ver2.0用に更新されたCSVファイル管理
│   ├── data_store.py     # メモリ内データストア
│   ├── data_store_updated.py # Ver2.0用に更新されたメモリ内データストア
│   └── __init__.py       # パッケージ初期化ファイル
├── config.py             # 設定ファイル
├── main.py               # メインモジュール
├── P1_data_collector_solo.py      # メインデータコレクター
├── P1_data_collector_solo_v2.0.py # Ver2.0用のデータコレクター
├── P1_data_collector_solo_updated.py # Ver2.0用に更新されたデータコレクター
└── __init__.py           # パッケージ初期化ファイル
```

## メインプログラムファイル

### P1_data_collector_solo_updated.py
**役割**: データ収集システムのメインエントリーポイント  
**説明**: このファイルは、P2、P3、P4、P5、P6デバイスからデータを受信、処理、保存するためのメインプログラムです。Ver2.0では、BME680センサーのみをサポートし、CO2センサー（MH-Z19C）はサポートしていません。  
**使用シーン**: システム全体を起動する際に使用します。

```bash
python3 P1_data_collector_solo_updated.py
```

オプションで、ポートとデータディレクトリを指定することもできます：

```bash
python3 P1_data_collector_solo_updated.py --port 5000 --data-dir /path/to/data
```

### P1_data_collector_solo_v2.0.py
**役割**: Ver2.0用のデータコレクター  
**説明**: このファイルは、Ver2.0用のデータコレクターです。BME680センサーのみをサポートし、CO2センサー（MH-Z19C）はサポートしていません。  
**使用シーン**: Ver2.0システムを使用する際に参照されます。

### P1_data_collector_solo.py
**役割**: 元のデータコレクター  
**説明**: このファイルは、元のデータコレクターです。BME680センサーとCO2センサー（MH-Z19C）の両方をサポートしています。  
**使用シーン**: 通常は使用せず、Ver2.0では P1_data_collector_solo_updated.py を使用します。

## サブディレクトリとファイル

### api/
APIサーバー関連のコードを含むディレクトリです。

#### routes.py
**役割**: API ルートハンドラ  
**説明**: このファイルは、データ収集システムのAPIエンドポイントを定義します。  
**使用シーン**: APIサーバーを起動する際に使用されます。

#### routes_updated.py
**役割**: Ver2.0用に更新されたAPI ルートハンドラ  
**説明**: このファイルは、Ver2.0用に更新されたAPIエンドポイントを定義します。BME680センサーのみをサポートし、P2、P3、P4、P5、P6デバイスをサポートするように更新されています。  
**使用シーン**: Ver2.0でAPIサーバーを起動する際に使用されます。

#### server.py
**役割**: API サーバー  
**説明**: このファイルは、Flaskを使用してAPIサーバーを実装します。  
**使用シーン**: APIサーバーを起動する際に使用されます。

### network/
ネットワーク通信関連のコードを含むディレクトリです。

#### server.py
**役割**: ソケットサーバー  
**説明**: このファイルは、P2、P3、P4、P5、P6デバイスからデータを受信するためのソケットサーバーを実装します。  
**使用シーン**: データ収集サーバーを起動する際に使用されます。

### processing/
データ処理関連のコードを含むディレクトリです。

#### calculation.py
**役割**: 計算関数  
**説明**: このファイルは、温度と湿度から絶対湿度を計算するなどの計算関数を提供します。  
**使用シーン**: データ処理中に使用されます。

#### validation.py
**役割**: データ検証関数  
**説明**: このファイルは、受信したデータを検証するための関数を提供します。  
**使用シーン**: データを受信する際に使用されます。

#### validation_updated.py
**役割**: Ver2.0用に更新されたデータ検証関数  
**説明**: このファイルは、Ver2.0用に更新されたデータ検証関数を提供します。BME680センサーのみをサポートし、P2、P3、P4、P5、P6デバイスをサポートするように更新されています。  
**使用シーン**: Ver2.0でデータを受信する際に使用されます。

### storage/
データ保存関連のコードを含むディレクトリです。

#### csv_manager.py
**役割**: CSVファイル管理  
**説明**: このファイルは、データをCSVファイルに保存するための関数を提供します。  
**使用シーン**: データを保存する際に使用されます。

#### csv_manager_updated.py
**役割**: Ver2.0用に更新されたCSVファイル管理  
**説明**: このファイルは、Ver2.0用に更新されたCSVファイル管理関数を提供します。BME680センサーのみをサポートし、P2、P3、P4、P5、P6デバイスをサポートするように更新されています。  
**使用シーン**: Ver2.0でデータを保存する際に使用されます。

#### data_store.py
**役割**: メモリ内データストア  
**説明**: このファイルは、最新のデータをメモリに保存するための関数を提供します。  
**使用シーン**: データを保存し、API経由でデータを取得する際に使用されます。

#### data_store_updated.py
**役割**: Ver2.0用に更新されたメモリ内データストア  
**説明**: このファイルは、Ver2.0用に更新されたメモリ内データストア関数を提供します。P2、P3、P4、P5、P6デバイスをサポートするように更新されています。  
**使用シーン**: Ver2.0でデータを保存し、API経由でデータを取得する際に使用されます。

### config.py
**役割**: 設定ファイル  
**説明**: このファイルは、データ収集システムの設定を定義します。  
**使用シーン**: システム全体の設定を変更する際に使用されます。

## 使用シナリオ

### 1. システム全体の起動
システム全体を起動するには、P1_data_collector_solo_updated.pyを実行します：

```bash
python3 P1_data_collector_solo_updated.py
```

これにより、以下が実行されます：
1. P2、P3、P4、P5、P6デバイスからデータを受信するためのソケットサーバーを起動
2. データにアクセスするためのAPIサーバーを起動
3. 古いCSVファイルを定期的にクリーンアップ

### 2. APIを使用したデータの取得
APIを使用してデータを取得するには、以下のエンドポイントを使用します：

- 最新のデータを取得: `/api/latest-data`
- 特定のデバイスのデータを取得: `/api/device/<device_id>`
- 特定のデバイスのCSVデータを取得: `/api/device/<device_id>/csv`
- すべてのデバイスのステータスを取得: `/api/status`

例えば、P2デバイスの最新データを取得するには：

```
http://localhost:5000/api/device/P2
```

### 3. CSVファイルの管理
CSVファイルは以下のディレクトリに保存されます：

- P2デバイス: `/var/lib/raspap_solo/data/RawData_P2/`
- P3デバイス: `/var/lib/raspap_solo/data/RawData_P3/`
- P4デバイス: `/var/lib/raspap_solo/data/RawData_P4/`
- P5デバイス: `/var/lib/raspap_solo/data/RawData_P5/`
- P6デバイス: `/var/lib/raspap_solo/data/RawData_P6/`

各デバイスディレクトリには以下のファイルが含まれます：
- 日付ベースのCSVファイル: `<device_id>_<YYYY-MM-DD>.csv`
- 固定CSVファイル: `<device_id>_fixed.csv`

古いCSVファイルは、設定された保持期間（デフォルトは30日）に基づいて自動的に削除されます。

## 注意事項
- Ver2.0では、BME680センサーのみをサポートし、CO2センサー（MH-Z19C）はサポートしていません。
- システムは、P2、P3、P4、P5、P6デバイスからデータを受信、処理、保存します。
- CSVファイルのヘッダーには、CO2センサーデータ用の空の列が含まれていますが、Ver2.0では使用されません。
- APIサーバーを使用するには、Flaskをインストールする必要があります。
- データディレクトリは、存在しない場合は自動的に作成されます。
- P1_data_collector_solo_updated.pyは、通常はroot権限（sudo）で実行する必要があります。
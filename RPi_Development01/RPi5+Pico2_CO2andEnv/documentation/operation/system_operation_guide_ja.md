# 環境データ測定システム操作ガイド
バージョン: 2.0.0

このガイドでは、インストール後のRaspberry Pi 5とPico 2W環境データ測定システムの操作方法について詳細な説明を提供します。

## 目次
1. [システム概要](#システム概要)
2. [システムの起動](#システムの起動)
3. [Webインターフェースへのアクセス](#webインターフェースへのアクセス)
4. [ダッシュボード概要](#ダッシュボード概要)
5. [リアルタイムデータの表示](#リアルタイムデータの表示)
6. [履歴データの表示](#履歴データの表示)
7. [データのエクスポート](#データのエクスポート)
8. [接続品質のモニタリング](#接続品質のモニタリング)
9. [システムメンテナンス](#システムメンテナンス)
10. [電源管理](#電源管理)
11. [一般的なタスク](#一般的なタスク)

## システム概要
環境データ測定システムは以下のコンポーネントで構成されています：
- **P1（Raspberry Pi 5）**：WiFiアクセスポイントとして機能し、データを収集し、Webインターフェースを提供する中央ハブ
- **P2およびP3（Raspberry Pi Pico 2W）**：環境データを収集してP1に送信するセンサーノード
- **センサー**：BME680（温度、湿度、気圧、ガス）およびMH-Z19B（CO2）

システムは以下のように動作します：
1. P2とP3は30秒ごとに環境データを収集します
2. データはWiFi経由でP1に送信されます
3. P1はデータを保存し、Webインターフェースを通じて利用可能にします
4. ユーザーはリアルタイムデータと履歴データを表示し、分析のためにエクスポートできます

## システムの起動
### P1（Raspberry Pi 5）の起動
1. Raspberry Pi 5を電源に接続します。
2. システムは自動的に起動し、以下のサービスを開始します：
   - アクセスポイントサービス（hostapd）
   - DHCPサーバー（dnsmasq）
   - データ収集サービス
   - Webインターフェース
   - 接続モニター

3. すべてのサービスが起動するまで約2分間待ちます。
4. アクセスポイントはSSID「RaspberryPi5_AP」（デフォルト）で利用可能になります。

### P2およびP3（Raspberry Pi Pico 2W）の起動
1. Pico 2Wデバイスを電源に接続します。
2. デバイスは自動的に起動し、main.pyスクリプトを実行します。
3. オンボードLEDがステータスを示します：
   - 急速な点滅：WiFiへの接続を試みています
   - 点灯：WiFiに接続済み
   - 時々の点滅：データ送信
   - 点滅パターン：エラーコード（トラブルシューティングガイドを参照）

4. デバイスは自動的にP1のWiFiネットワークに接続し、データの送信を開始します。

## Webインターフェースへのアクセス
1. デバイス（スマートフォン、タブレット、またはコンピュータ）を「RaspberryPi5_AP」WiFiネットワークに接続します。
   - デフォルトパスワード：「raspberry」

2. Webブラウザを開き、以下のアドレスにアクセスします：
   ```
   http://192.168.0.1
   ```

   > 注：セットアップ時に異なるIPアドレスを設定した場合は、そのアドレスを使用してください。

3. 環境データダッシュボードが読み込まれ、P2とP3からの現在の測定値が表示されるはずです。

4. ダッシュボードにアクセスできない場合：
   - 正しいWiFiネットワークに接続されていることを確認します
   - IPアドレスに直接アクセスしてみてください
   - P1ですべてのサービスが実行されていることを確認します（トラブルシューティングガイドを参照）

## ダッシュボード概要
ダッシュボードはいくつかのセクションで構成されています：

### ホームページ
- 現在のステータスを含むシステム概要
- P2とP3からの最新の測定値のクイックビュー
- 各デバイスの詳細ダッシュボードへのナビゲーション

### デバイスダッシュボード（P2およびP3）
- 最新のセンサー値を表示する現在の測定値パネル
- 各環境パラメータのタイムシリーズグラフ：
  - 温度（°C）
  - 湿度（%）
  - 気圧（hPa）
  - ガス抵抗（Ohm）
  - CO2レベル（ppm）
- データエクスポートツール
- 時間範囲セレクタ（1日、1週間、1ヶ月）

### 接続モニター
- P2とP3の信号強度インジケータ
- ping時間と接続品質メトリクス
- 履歴接続データ

## リアルタイムデータの表示
1. ホームページから、「P2ダッシュボード」または「P3ダッシュボード」をクリックして、特定のデバイスの詳細データを表示します。

2. 「現在の測定値」パネルには、以下の最新の値が表示されます：
   - 温度
   - 湿度
   - 気圧
   - ガス抵抗
   - CO2レベル

3. データは30秒ごとに自動的に更新されます。

4. データを手動で更新するには、ブラウザの更新ボタンをクリックします。

5. 最終更新のタイムスタンプはページの下部に表示されます。

## 履歴データの表示
1. デバイスダッシュボード（P2またはP3）から、時間範囲セレクタボタンを使用して期間を選択します：
   - 1日（デフォルト）
   - 1週間
   - 1ヶ月

2. グラフは選択した時間期間のデータを表示するように更新されます。

3. グラフ上の任意のポイントにカーソルを合わせると、正確な値とタイムスタンプが表示されます。

4. グラフコントロールを使用して：
   - ズームイン/アウト
   - 左右にパン
   - ビューをリセット
   - グラフを画像としてダウンロード

5. 特定のパラメータをより詳細に表示するには、そのグラフをクリックして拡大します。

## データのエクスポート
1. デバイスダッシュボード（P2またはP3）から、「データのエクスポート」パネルを見つけます。

2. エクスポートしたいデータの日付範囲を選択します：
   - 開始日
   - 終了日

3. 「CSVをエクスポート」ボタンをクリックします。

4. 選択した日付範囲内のすべてのデータポイントを含むCSVファイルがデバイスにダウンロードされます。

5. CSVファイルには以下の列が含まれます：
   - timestamp（タイムスタンプ）
   - device_id（デバイスID）
   - temperature（温度）
   - humidity（湿度）
   - pressure（気圧）
   - gas_resistance（ガス抵抗）
   - co2_level（CO2レベル）

6. このファイルは表計算ソフトウェア（Excel、Google Sheetsなど）やデータ分析ツールで開いて、さらに処理することができます。

## 接続品質のモニタリング
1. ホームページから「接続モニター」をクリックして、接続品質ダッシュボードを表示します。

2. ダッシュボードには以下が表示されます：
   - P2とP3の現在の信号強度（dBm単位）
   - 信号対雑音比
   - ping時間（ms単位）
   - 接続ステータス（オンライン/オフライン）

3. 信号強度は以下のように分類されます：
   - 優秀：-50 dBm以上
   - 非常に良い：-50〜-60 dBm
   - 良い：-60〜-70 dBm
   - 普通：-70〜-80 dBm
   - 悪い：-80 dBm未満

4. 履歴接続データはグラフとして表示され、時間の経過に伴うパターンや問題を特定できます。

5. この情報を使用して、最適な接続品質を得るためにP2とP3デバイスの配置を最適化します。

## システムメンテナンス
### システムステータスの確認
1. SSHを介して、または直接キーボードとモニターを使用してRaspberry Pi 5に接続します。

2. すべてのサービスのステータスを確認します：
   ```bash
   sudo systemctl status hostapd
   sudo systemctl status dnsmasq
   sudo systemctl status data_collector.service
   sudo systemctl status web_interface.service
   sudo systemctl status wifi_monitor.service
   ```

3. システムログでエラーがないか確認します：
   ```bash
   sudo journalctl -u data_collector.service -n 50
   sudo journalctl -u web_interface.service -n 50
   sudo journalctl -u wifi_monitor.service -n 50
   ```

### サービスの再起動
サービスが正しく動作していない場合は、再起動できます：

1. データコレクターを再起動します：
   ```bash
   sudo systemctl restart data_collector.service
   ```

2. Webインターフェースを再起動します：
   ```bash
   sudo systemctl restart web_interface.service
   ```

3. 接続モニターを再起動します：
   ```bash
   sudo systemctl restart wifi_monitor.service
   ```

4. アクセスポイントを再起動します：
   ```bash
   sudo systemctl restart hostapd
   sudo systemctl restart dnsmasq
   ```

### ディスク容量の確認
1. 利用可能なディスク容量を確認します：
   ```bash
   df -h
   ```

2. ディスク容量が少ない場合は、古いデータファイルを削除できます：
   ```bash
   # サイズ別にデータファイルを一覧表示
   du -h /var/lib(FromThonny)/raspap/data | sort -h

   # 古いファイルを削除（例：30日以上前のファイル）
   find /var/lib(FromThonny)/raspap/data -name "*.csv" -type f -mtime +30 -delete
   ```

### システムアップデート
1. Raspberry Pi OSを更新します：
   ```bash
   sudo apt update
   sudo apt upgrade -y
   ```

2. 更新後に再起動します：
   ```bash
   sudo reboot
   ```

## 電源管理
### P1（Raspberry Pi 5）
- Raspberry Pi 5は常に安定した電源に接続されている必要があります。
- バッテリーバックアップやUPSを使用する場合は、少なくとも5V/3Aを供給できることを確認してください。
- Raspberry Pi 5を安全にシャットダウンするには：
  ```bash
  sudo shutdown -h now
  ```
- 電源を切断する前に、システムが完全にシャットダウンするのを待ちます。

### P2およびP3（Raspberry Pi Pico 2W）
- Pico 2WデバイスはUSBまたは外部電源から電力を供給できます。
- バッテリー駆動の場合は、USB出力付きのモバイルバッテリーやバッテリーパックの使用を検討してください。
- Pico 2Wデバイスはエラーが発生すると自動的に再起動します。
- Pico 2Wを手動で再起動するには、電源を切断して再接続します。

## 一般的なタスク
### WiFiパスワードの変更
1. SSHを介して、または直接Raspberry Pi 5に接続します。

2. アクセスポイント設定スクリプトを実行します：
   ```bash
   sudo python3 ~/RPi_Development01/p1_software/ap_setup/ap_setup.py --configure
   ```

3. プロンプトに従ってパスワードを更新します。

4. Raspberry Pi 5を再起動します：
   ```bash
   sudo reboot
   ```

5. P2およびP3デバイスの設定を更新して、新しいパスワードを使用するようにします。

### データ収集間隔の調整
1. SSHを介して、または直接Raspberry Pi 5に接続します。

2. データコレクター設定を編集します：
   ```bash
   sudo nano ~/RPi_Development01/p1_software/data_collection/data_collector.py
   ```

3. `DEFAULT_CONFIG`セクションを見つけて、関連するパラメータを変更します。

4. ファイルを保存してサービスを再起動します：
   ```bash
   sudo systemctl restart data_collector.service
   ```

5. P2およびP3デバイスについては、コンピュータに接続してThonnyを使用してmain.pyファイルを編集し、`TRANSMISSION_INTERVAL`値を調整します。

### データのバックアップ
1. SSHを介して、または直接Raspberry Pi 5に接続します。

2. データディレクトリのバックアップを作成します：
   ```bash
   sudo tar -czvf ~/environmental_data_backup_$(date +%Y%m%d).tar.gz /var/lib(FromThonny)/raspap/data
   ```

3. バックアップファイルを別のデバイスまたはストレージメディアにコピーします：
   ```bash
   # 例：USBドライブにコピー
   sudo cp ~/environmental_data_backup_*.tar.gz /media/pi/USB_DRIVE/

   # 例：SCP使用（別のコンピュータから）
   scp pi@192.168.0.1:~/environmental_data_backup_*.tar.gz /path/on/your/computer/
   ```

### P2およびP3デバイスのリセット
Pico 2Wデバイスが正しく機能していない場合：

1. USBケーブルを使用してデバイスをコンピュータに接続します。

2. Thonny IDEを開いてデバイスに接続します。

3. デバイスが応答する場合は、以下を実行できます：
   ```python
   import machine
   machine.reset()
   ```

4. デバイスが応答しない場合は、USBケーブルを接続しながらBOOTSELボタンを押し続け、MicroPythonファームウェアとプロジェクトファイルを再インストールします。

特定のタスクやトラブルシューティングに関する詳細情報については、[トラブルシューティングガイド](../troubleshooting/troubleshooting_guide_ja.md)を参照してください。
